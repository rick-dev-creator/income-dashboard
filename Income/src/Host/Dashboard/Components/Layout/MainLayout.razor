@inherits LayoutComponentBase
@implements IDisposable
@inject MudTheme Theme
@inject Income.Application.Services.Notifications.INotificationService NotificationService
@inject Dashboard.Services.AppState AppState
@using Income.Application.Services.Notifications
@using Dashboard.Services

<MudThemeProvider Theme="Theme" @bind-IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<CascadingValue Value="_isDarkMode" Name="IsDarkMode">
<MudLayout>
    <MudAppBar Elevation="1" Class="app-bar">
        <MudIconButton Icon="@Icons.Material.Rounded.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@ToggleDrawer" />

        <div class="brand">
            <div class="brand-icon">
                <MudIcon Icon="@Icons.Material.Rounded.ShowChart" Size="Size.Small" />
            </div>
            <MudText Typo="Typo.h6" Class="brand-text">FlowMetrics</MudText>
        </div>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <MudMenu AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter">
                <ActivatorContent>
                    <MudButton Variant="Variant.Text" EndIcon="@Icons.Material.Rounded.KeyboardArrowDown"
                               Class="@($"mode-button {GetModeClass()}")">
                        <div class="@($"mode-indicator {GetModeClass()}")"></div>
                        @AppState.ModeDisplayName
                    </MudButton>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem OnClick="@(() => SetMode(AppMode.Income))">
                        <div class="mode-menu-item">
                            <div class="mode-indicator income"></div>
                            <span>Income</span>
                            @if (AppState.CurrentMode == AppMode.Income)
                            {
                                <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Primary" />
                            }
                        </div>
                    </MudMenuItem>
                    <MudMenuItem OnClick="@(() => SetMode(AppMode.Outcome))">
                        <div class="mode-menu-item">
                            <div class="mode-indicator outcome"></div>
                            <span>Outcome</span>
                            @if (AppState.CurrentMode == AppMode.Outcome)
                            {
                                <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Primary" />
                            }
                        </div>
                    </MudMenuItem>
                    <MudDivider Class="my-2" />
                    <MudMenuItem OnClick="@(() => SetMode(AppMode.Divergence))">
                        <div class="mode-menu-item">
                            <div class="mode-indicator divergence"></div>
                            <span>Divergence</span>
                            @if (AppState.CurrentMode == AppMode.Divergence)
                            {
                                <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Primary" />
                            }
                        </div>
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
        </div>

        <MudSpacer />

        <!-- Notifications Bell -->
        <MudMenu @ref="_notificationMenu" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <ActivatorContent>
                <MudBadge Content="@_unreadCount" Visible="@(_unreadCount > 0)" Color="Color.Error" Overlap="true" @onclick="RefreshOnMenuOpen">
                    <MudIconButton Icon="@Icons.Material.Rounded.Notifications"
                                   Color="Color.Inherit" />
                </MudBadge>
            </ActivatorContent>
            <ChildContent>
                <div class="notification-panel">
                    <div class="notification-header">
                        <MudText Typo="Typo.subtitle1" Class="notification-title">Notifications</MudText>
                        <MudSpacer />
                        @if (_unreadCount > 0)
                        {
                            <MudButton Size="Size.Small" Color="Color.Primary" Variant="Variant.Text" OnClick="MarkAllAsRead">
                                Mark all read
                            </MudButton>
                        }
                        @if (_notifications.Count > 0)
                        {
                            <MudTooltip Text="Clear all">
                                <MudIconButton Icon="@Icons.Material.Rounded.DeleteSweep" Size="Size.Small" Color="Color.Error" OnClick="ClearAllNotifications" />
                            </MudTooltip>
                        }
                    </div>
                    <MudDivider />
                    @if (_notifications.Count == 0)
                    {
                        <div class="notification-empty">
                            <MudIcon Icon="@Icons.Material.Rounded.NotificationsNone" Size="Size.Large" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">No notifications yet</MudText>
                        </div>
                    }
                    else
                    {
                        <div class="notification-list">
                            @foreach (var notification in _notifications.Take(10))
                            {
                                <div class="notification-item @(notification.IsRead ? "" : "unread")" @onclick="@(() => MarkAsRead(notification))">
                                    <div class="notification-icon @GetNotificationIconClass(notification.Type)">
                                        <MudIcon Icon="@GetNotificationIcon(notification.Type)" Size="Size.Small" />
                                    </div>
                                    <div class="notification-content">
                                        <MudText Typo="Typo.body2" Class="notification-item-title">@notification.Title</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="notification-message">@notification.Message</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="notification-time">@FormatTimeAgo(notification.CreatedAt)</MudText>
                                    </div>
                                    @if (!notification.IsRead)
                                    {
                                        <div class="unread-dot"></div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </ChildContent>
        </MudMenu>

        <MudTooltip Text="@(_isDarkMode ? "Light mode" : "Dark mode")" Placement="Placement.Bottom">
            <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Rounded.LightMode : Icons.Material.Rounded.DarkMode)"
                           Color="Color.Inherit"
                           OnClick="@ToggleDarkMode" />
        </MudTooltip>

        <MudMenu Icon="@Icons.Material.Rounded.AccountCircle" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <MudMenuItem Icon="@Icons.Material.Rounded.Settings">Settings</MudMenuItem>
            <MudMenuItem Icon="@Icons.Material.Rounded.Help">Help</MudMenuItem>
            <MudDivider Class="my-2" />
            <MudMenuItem Icon="@Icons.Material.Rounded.Logout">Sign Out</MudMenuItem>
        </MudMenu>
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen"
               ClipMode="DrawerClipMode.Always"
               Breakpoint="Breakpoint.Md"
               Elevation="1"
               Variant="DrawerVariant.Responsive"
               Class="app-drawer">
        <MudDrawerHeader>
            <MudText Typo="Typo.subtitle1" Class="drawer-section-title">NAVIGATION</MudText>
        </MudDrawerHeader>
        <NavMenu />
        <MudSpacer />
        <div class="drawer-footer">
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="version-text">v1.0.0</MudText>
        </div>
    </MudDrawer>

    <MudMainContent Class="main-content" Style="@GetBackgroundStyle()">
        <div class="page-container">
            @Body
        </div>
    </MudMainContent>
</MudLayout>
</CascadingValue>

<style>
    .app-bar {
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
    }

    .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-left: 8px;
    }

    .brand-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-secondary) 100%);
        color: white;
    }

    .brand-text {
        font-weight: 700;
        letter-spacing: -0.02em;
        background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .app-drawer {
        border-right: 1px solid var(--mud-palette-divider) !important;
    }

    .drawer-section-title {
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        font-weight: 600;
    }

    .drawer-footer {
        padding: 16px;
        border-top: 1px solid var(--mud-palette-divider);
    }

    .version-text {
        opacity: 0.5;
    }

    .main-content {
        background: var(--mud-palette-background);
        min-height: calc(100vh - 64px);
    }

    .page-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 24px 32px;
    }

    @@media (max-width: 960px) {
        .page-container {
            padding: 16px;
        }

        .brand-text {
            display: none;
        }
    }

    /* Notification Panel Styles */
    .notification-panel {
        width: 380px;
        max-height: 480px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
    }

    .notification-title {
        font-weight: 600;
    }

    .notification-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        gap: 12px;
    }

    .notification-list {
        overflow-y: auto;
        max-height: 380px;
    }

    .notification-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px 16px;
        cursor: pointer;
        transition: background 0.2s ease;
        position: relative;
    }

    .notification-item:hover {
        background: var(--mud-palette-action-default-hover);
    }

    .notification-item.unread {
        background: rgba(99, 102, 241, 0.08);
    }

    .notification-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        color: white;
    }

    .notification-icon.icon-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .notification-icon.icon-error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .notification-content {
        flex: 1;
        min-width: 0;
    }

    .notification-item-title {
        font-weight: 500;
        line-height: 1.3;
    }

    .notification-message {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-top: 2px;
    }

    .notification-time {
        margin-top: 4px;
        opacity: 0.7;
    }

    .unread-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--mud-palette-primary);
        flex-shrink: 0;
        margin-top: 4px;
    }

    @@media (max-width: 600px) {
        .notification-panel {
            width: 100vw;
            max-width: 100vw;
        }
    }

    /* Mode Selector Styles */
    .mode-selector {
        margin-left: 16px;
    }

    .mode-button {
        text-transform: none;
        font-weight: 500;
        padding: 6px 12px;
        border-radius: 8px;
        transition: background 0.2s ease;
    }

    .mode-button:hover {
        background: var(--mud-palette-action-default-hover);
    }

    .mode-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .mode-indicator.income {
        background: #10b981;
    }

    .mode-indicator.outcome {
        background: #ef4444;
    }

    .mode-indicator.divergence {
        background: #8b5cf6;
    }

    .mode-menu-item {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
    }

    .mode-menu-item span {
        flex: 1;
    }

    @@media (max-width: 600px) {
        .mode-selector {
            margin-left: 8px;
        }

        .mode-button span:not(.mode-indicator) {
            display: none;
        }
    }
</style>

@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = true;
    private MudMenu? _notificationMenu;
    private List<NotificationItem> _notifications = [];
    private int _unreadCount;
    private System.Timers.Timer? _refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadNotificationsAsync();

        // Refresh notifications every 30 seconds
        _refreshTimer = new System.Timers.Timer(30000);
        _refreshTimer.Elapsed += async (sender, e) => await RefreshNotifications();
        _refreshTimer.Start();
    }

    private async Task LoadNotificationsAsync()
    {
        var result = await NotificationService.GetAllAsync(50);
        if (result.IsSuccess)
            _notifications = result.Value.ToList();

        var countResult = await NotificationService.GetUnreadCountAsync();
        if (countResult.IsSuccess)
            _unreadCount = countResult.Value;
    }

    private async Task RefreshNotifications()
    {
        await LoadNotificationsAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshOnMenuOpen()
    {
        await LoadNotificationsAsync();
    }

    private async Task MarkAsRead(NotificationItem notification)
    {
        if (notification.IsRead) return;

        await NotificationService.MarkAsReadAsync(notification.Id);
        await LoadNotificationsAsync();
        StateHasChanged();
    }

    private async Task MarkAllAsRead()
    {
        await NotificationService.MarkAllAsReadAsync();
        await LoadNotificationsAsync();
        StateHasChanged();
    }

    private async Task ClearAllNotifications()
    {
        await NotificationService.ClearAllAsync();
        await LoadNotificationsAsync();
        StateHasChanged();
    }

    private static string GetNotificationIcon(string type) => type switch
    {
        NotificationTypes.SyncSuccess or NotificationTypes.RecurringSuccess => Icons.Material.Rounded.CheckCircle,
        NotificationTypes.SyncError or NotificationTypes.RecurringError => Icons.Material.Rounded.Error,
        _ => Icons.Material.Rounded.Notifications
    };

    private static string GetNotificationIconClass(string type) => type switch
    {
        NotificationTypes.SyncSuccess or NotificationTypes.RecurringSuccess => "icon-success",
        NotificationTypes.SyncError or NotificationTypes.RecurringError => "icon-error",
        _ => ""
    };

    private static string FormatTimeAgo(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;
        if (diff.TotalMinutes < 1) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";
        return dateTime.ToString("MMM dd");
    }

    private void ToggleDrawer() => _drawerOpen = !_drawerOpen;
    private void ToggleDarkMode() => _isDarkMode = !_isDarkMode;

    private void SetMode(AppMode mode)
    {
        AppState.CurrentMode = mode;
        StateHasChanged();
    }

    private string GetModeClass() => AppState.CurrentMode switch
    {
        AppMode.Income => "income",
        AppMode.Outcome => "outcome",
        AppMode.Divergence => "divergence",
        _ => "income"
    };

    private string GetBackgroundStyle()
    {
        var tint = AppState.CurrentMode switch
        {
            AppMode.Income => _isDarkMode
                ? "linear-gradient(180deg, rgba(16,185,129,0.03) 0%, transparent 50%)"
                : "linear-gradient(180deg, rgba(16,185,129,0.04) 0%, transparent 50%)",
            AppMode.Outcome => _isDarkMode
                ? "linear-gradient(180deg, rgba(239,68,68,0.03) 0%, transparent 50%)"
                : "linear-gradient(180deg, rgba(239,68,68,0.04) 0%, transparent 50%)",
            AppMode.Divergence => _isDarkMode
                ? "linear-gradient(180deg, rgba(139,92,246,0.03) 0%, transparent 50%)"
                : "linear-gradient(180deg, rgba(139,92,246,0.04) 0%, transparent 50%)",
            _ => ""
        };
        return $"background: {tint};";
    }

    public void Dispose()
    {
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
    }
}
