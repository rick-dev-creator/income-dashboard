@page "/"
@using Analytics.Application.Services
@implements IDisposable
@inject IDashboardService DashboardService
@rendermode InteractiveServer

<PageTitle>FlowMetrics - Income Dashboard</PageTitle>

<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <p class="page-subtitle">Your financial overview at a glance</p>
</div>

@if (_isLoading)
{
    <div class="loading-container">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-3">Loading your dashboard...</MudText>
    </div>
}
else if (_error is not null)
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4 animate-fade-in">@_error</MudAlert>
}
else
{
    <!-- THE 3 KEY QUESTIONS -->
    <div class="kpi-grid animate-slide-up">
        <!-- WHERE AM I? -->
        <div class="stat-card gradient-primary hover-lift">
            <div class="stat-card-icon">
                <MudIcon Icon="@Icons.Material.Rounded.Speed" Size="Size.Large" />
            </div>
            <div class="stat-card-label">Where am I?</div>
            <div class="stat-card-value">
                @FormatCurrency(_kpis?.DailyRate.AverageDailyUsd ?? 0)<span class="stat-card-unit">/day</span>
            </div>
            <div class="stat-card-subtitle">
                avg last @(_kpis?.DailyRate.DaysAnalyzed ?? 30) days
            </div>
            @if (_sparklineData.Count > 0)
            {
                <div class="sparkline-container">
                    <ApexChart @key="@($"sparkline_{IsDarkMode}")"
                               TItem="SparklinePoint"
                               Options="_sparklineOptions"
                               Height="40">
                        <ApexPointSeries TItem="SparklinePoint"
                                         Items="_sparklineData"
                                         SeriesType="SeriesType.Area"
                                         XValue="@(p => p.Label)"
                                         YValue="@(p => p.Value)" />
                    </ApexChart>
                </div>
            }
        </div>

        <!-- WHERE AM I GOING? -->
        <div class="stat-card @GetTrendGradientClass(_kpis?.Trend.Direction) hover-lift">
            <div class="stat-card-icon">
                <MudIcon Icon="@GetTrendArrowIcon(_kpis?.Trend.Direction)" Size="Size.Large" />
            </div>
            <div class="stat-card-label">Where am I going?</div>
            <div class="stat-card-value">
                @FormatSignedPercentage(_kpis?.Trend.ChangePercentage ?? 0)
            </div>
            <div class="stat-card-subtitle">
                @(_kpis?.Trend.ComparisonPeriod ?? "vs last month")
            </div>
            <div class="stat-card-meta">
                <MudIcon Icon="@Icons.Material.Rounded.Timeline" Size="Size.Small" />
                <span>@(_kpis?.Trend.Direction ?? "Stable") trend</span>
            </div>
        </div>

        <!-- WHERE WILL I BE? -->
        <div class="stat-card gradient-purple hover-lift">
            <div class="stat-card-icon">
                <MudIcon Icon="@Icons.Material.Rounded.RocketLaunch" Size="Size.Large" />
            </div>
            <div class="stat-card-label">Where will I be?</div>
            <div class="stat-card-value">
                @FormatCurrency(_kpis?.Projection.Projected6MonthTotalUsd ?? 0)
            </div>
            <div class="stat-card-subtitle">
                projected in 6 months
            </div>
            <div class="confidence-bar">
                <span class="confidence-label">Confidence</span>
                <div class="confidence-track">
                    <div class="confidence-fill" style="width: @((_kpis?.Projection.ConfidenceScore ?? 0) * 100)%"></div>
                </div>
                <span class="confidence-value">@(((_kpis?.Projection.ConfidenceScore ?? 0) * 100).ToString("F0"))%</span>
            </div>
        </div>
    </div>

    <!-- CHARTS ROW -->
    <div class="charts-row mt-6">
        <!-- INCOME OVER TIME -->
        <div class="card-modern chart-main animate-slide-up" style="animation-delay: 0.1s;">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Income Over Time</h2>
                    <p class="page-subtitle" style="margin-top: 4px;">Track your earnings progression</p>
                </div>
                <MudToggleGroup T="string" Value="_selectedGranularity" ValueChanged="OnGranularityChanged" Color="Color.Primary" CheckMark="false" Class="toggle-rounded">
                    <MudToggleItem Value="@("Daily")">Daily</MudToggleItem>
                    <MudToggleItem Value="@("Weekly")">Weekly</MudToggleItem>
                    <MudToggleItem Value="@("Monthly")">Monthly</MudToggleItem>
                </MudToggleGroup>
            </div>

            @if (_isLoadingChart)
            {
                <div style="display: flex; justify-content: center; padding: 60px 0;">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </div>
            }
            else if (_stackedTimeSeries?.Points.Count > 0)
            {
                <ApexChart @key="@($"main_{_selectedGranularity}_{IsDarkMode}")"
                           TItem="ChartDataPoint"
                           Options="_areaChartOptions"
                           Height="320"
                           @ref="_mainChart">
                    @foreach (var series in _apexChartSeries)
                    {
                        <ApexPointSeries TItem="ChartDataPoint"
                                         Items="series.Data"
                                         Name="@series.Name"
                                         SeriesType="SeriesType.Bar"
                                         XValue="@(p => p.Date)"
                                         YValue="@(p => p.Amount)" />
                    }
                </ApexChart>
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <MudIcon Icon="@Icons.Material.Rounded.BarChart" Size="Size.Large" Color="Color.Secondary" />
                    </div>
                    <MudText Typo="Typo.h6">No income data yet</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Add income streams and record snapshots to see your trends</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" Href="/streams" StartIcon="@Icons.Material.Rounded.Add">
                        Add Stream
                    </MudButton>
                </div>
            }
        </div>

        <!-- INCOME DISTRIBUTION -->
        <div class="card-modern chart-side animate-slide-up" style="animation-delay: 0.15s;">
            <div class="section-header">
                <h2 class="section-title">Distribution</h2>
            </div>

            @if (_donutData.Count > 0)
            {
                <ApexChart @key="@($"donut_{IsDarkMode}")"
                           TItem="DonutDataPoint"
                           Options="_donutChartOptions"
                           Height="280">
                    <ApexPointSeries TItem="DonutDataPoint"
                                     Items="_donutData"
                                     SeriesType="SeriesType.Donut"
                                     XValue="@(p => p.Label)"
                                     YValue="@(p => p.Value)"
                                     OrderBy="@(p => p.Y)" />
                </ApexChart>

                <div class="donut-legend">
                    @foreach (var item in _donutData.OrderByDescending(d => d.Value).Take(5))
                    {
                        <div class="donut-legend-item">
                            <span class="donut-legend-dot" style="background: @GetStreamColor(item.Label);"></span>
                            <span class="donut-legend-label">@item.Label</span>
                            <span class="donut-legend-value">@FormatCurrency(item.Value)</span>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state-small">
                    <MudIcon Icon="@Icons.Material.Rounded.PieChart" Size="Size.Medium" Color="Color.Secondary" />
                    <MudText Typo="Typo.body2" Color="Color.Secondary">No data</MudText>
                </div>
            }
        </div>
    </div>

    <!-- STREAM HEALTH -->
    <div class="card-modern mt-6 animate-slide-up" style="animation-delay: 0.2s;">
        <div class="section-header">
            <div>
                <h2 class="section-title">Stream Health</h2>
                <p class="page-subtitle" style="margin-top: 4px;">Performance by income source</p>
            </div>
            <div class="health-badges">
                <div class="health-badge health-badge-success">
                    <MudIcon Icon="@Icons.Material.Rounded.TrendingUp" Size="Size.Small" />
                    <span>@(_streamHealth?.GrowingCount ?? 0) Growing</span>
                </div>
                <div class="health-badge health-badge-neutral">
                    <MudIcon Icon="@Icons.Material.Rounded.TrendingFlat" Size="Size.Small" />
                    <span>@(_streamHealth?.StableCount ?? 0) Stable</span>
                </div>
                <div class="health-badge health-badge-error">
                    <MudIcon Icon="@Icons.Material.Rounded.TrendingDown" Size="Size.Small" />
                    <span>@(_streamHealth?.DecliningCount ?? 0) Declining</span>
                </div>
            </div>
        </div>

        @if (_streamHealth?.Streams.Count > 0)
        {
            <div class="stream-list">
                @foreach (var stream in _streamHealth.Streams)
                {
                    <div class="stream-item">
                        <div class="stream-info">
                            <div class="stream-avatar @GetCategoryClass(stream.Category)">
                                @stream.StreamName[0]
                            </div>
                            <div class="stream-details">
                                <span class="stream-name">@stream.StreamName</span>
                                <span class="stream-provider">@stream.ProviderName</span>
                            </div>
                        </div>
                        <div class="stream-category">
                            <span class="category-chip @GetCategoryClass(stream.Category)">@stream.Category</span>
                        </div>
                        <div class="stream-trend">
                            <MudIcon Icon="@GetDirectionIcon(stream.Direction)"
                                     Color="@GetDirectionColor(stream.Direction)"
                                     Size="Size.Small" />
                        </div>
                        <div class="stream-amount">
                            <span class="amount-value">@FormatCurrency(stream.CurrentPeriodUsd)</span>
                            <span class="amount-label">this period</span>
                        </div>
                        <div class="stream-change @GetChangeClass(stream.Direction)">
                            <span class="change-percent">@FormatSignedPercentage(stream.ChangePercentage)</span>
                            <span class="change-amount">@FormatSignedCurrency(stream.ChangeUsd)</span>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-state-icon">
                    <MudIcon Icon="@Icons.Material.Rounded.Assessment" Size="Size.Large" Color="Color.Secondary" />
                </div>
                <MudText Typo="Typo.h6">No streams to analyze</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Add your first income stream to track its performance</MudText>
            </div>
        }
    </div>
}

<style>
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
    }

    @@media (max-width: 1279px) {
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 767px) {
        .kpi-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }
    }

    .stat-card {
        position: relative;
        padding: 28px;
        border-radius: 20px;
        color: white;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        pointer-events: none;
    }

    .stat-card-icon {
        position: absolute;
        top: 20px;
        right: 20px;
        opacity: 0.3;
    }

    .stat-card-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        opacity: 0.85;
        margin-bottom: 12px;
    }

    .stat-card-value {
        font-size: 2.25rem;
        font-weight: 700;
        line-height: 1.1;
        margin-bottom: 4px;
    }

    .stat-card-unit {
        font-size: 0.5em;
        opacity: 0.75;
        font-weight: 500;
    }

    .stat-card-subtitle {
        font-size: 0.875rem;
        opacity: 0.75;
        margin-bottom: 16px;
    }

    .stat-card-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        opacity: 0.65;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.15);
    }

    .confidence-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.15);
    }

    .confidence-label {
        font-size: 0.75rem;
        opacity: 0.65;
    }

    .confidence-track {
        flex: 1;
        height: 6px;
        background: rgba(255,255,255,0.2);
        border-radius: 3px;
        overflow: hidden;
    }

    .confidence-fill {
        height: 100%;
        background: rgba(255,255,255,0.8);
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .confidence-value {
        font-size: 0.75rem;
        font-weight: 600;
    }

    .chart-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid var(--mud-palette-divider);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 3px;
    }

    .legend-label {
        font-size: 0.8125rem;
        color: var(--mud-palette-text-secondary);
    }

    .health-badges {
        display: flex;
        gap: 12px;
    }

    .health-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8125rem;
        font-weight: 500;
    }

    .health-badge-success {
        background: rgba(16, 185, 129, 0.15);
        color: var(--mud-palette-success);
    }

    .health-badge-neutral {
        background: var(--mud-palette-divider);
        color: var(--mud-palette-text-secondary);
    }

    .health-badge-error {
        background: rgba(239, 68, 68, 0.15);
        color: var(--mud-palette-error);
    }

    .stream-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .stream-item {
        display: grid;
        grid-template-columns: 2fr 1fr 60px 1fr 1fr;
        align-items: center;
        padding: 16px;
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    .stream-item:hover {
        border-color: var(--mud-palette-primary);
        transform: translateX(4px);
    }

    .stream-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .stream-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
        color: white;
    }

    .stream-avatar.category-salary { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    .stream-avatar.category-trading { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .stream-avatar.category-subscription { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .stream-avatar.category-referral { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .stream-avatar.category-default { background: linear-gradient(135deg, #64748b 0%, #475569 100%); }

    .stream-details {
        display: flex;
        flex-direction: column;
    }

    .stream-name {
        font-weight: 600;
        font-size: 0.9375rem;
    }

    .stream-provider {
        font-size: 0.8125rem;
        color: var(--mud-palette-text-secondary);
    }

    .category-chip {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .category-chip.category-salary { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
    .category-chip.category-trading { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
    .category-chip.category-subscription { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
    .category-chip.category-referral { background: rgba(16, 185, 129, 0.15); color: #34d399; }
    .category-chip.category-default { background: var(--mud-palette-divider); color: var(--mud-palette-text-secondary); }

    .stream-trend {
        display: flex;
        justify-content: center;
    }

    .stream-amount {
        display: flex;
        flex-direction: column;
        text-align: right;
    }

    .amount-value {
        font-weight: 600;
        font-size: 0.9375rem;
    }

    .amount-label {
        font-size: 0.75rem;
        color: var(--mud-palette-text-secondary);
    }

    .stream-change {
        display: flex;
        flex-direction: column;
        text-align: right;
    }

    .stream-change.change-up { color: var(--mud-palette-success); }
    .stream-change.change-down { color: var(--mud-palette-error); }
    .stream-change.change-flat { color: var(--mud-palette-text-secondary); }

    .change-percent {
        font-weight: 600;
        font-size: 0.9375rem;
    }

    .change-amount {
        font-size: 0.75rem;
        opacity: 0.75;
    }

    .toggle-rounded {
        border-radius: 10px;
        overflow: hidden;
    }

    /* Charts row layout */
    .charts-row {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 24px;
    }

    .chart-main {
        min-width: 0;
    }

    .chart-side {
        min-width: 0;
    }

    /* Sparkline in KPI card */
    .sparkline-container {
        margin-top: 12px;
        margin-left: -8px;
        margin-right: -8px;
        opacity: 0.9;
    }

    /* Donut legend */
    .donut-legend {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--mud-palette-divider);
    }

    .donut-legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .donut-legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 3px;
        flex-shrink: 0;
    }

    .donut-legend-label {
        flex: 1;
        font-size: 0.8125rem;
        color: var(--mud-palette-text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .donut-legend-value {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--mud-palette-text-primary);
    }

    .empty-state-small {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 40px 20px;
        opacity: 0.6;
    }

    @@media (max-width: 1279px) {
        .charts-row {
            grid-template-columns: 1fr;
        }

        .chart-side {
            order: -1;
        }

        .stream-item {
            grid-template-columns: 2fr 1fr 1fr;
        }

        .stream-category {
            display: none;
        }
    }

    @@media (max-width: 767px) {
        .health-badges {
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .health-badge {
            padding: 4px 10px;
            font-size: 0.75rem;
        }

        .stream-item {
            grid-template-columns: 1fr;
            gap: 12px;
            padding: 14px;
        }

        .stream-category,
        .stream-trend {
            display: none;
        }

        .stream-info {
            flex: 1;
        }

        .stream-amount,
        .stream-change {
            text-align: left;
            flex-direction: row;
            gap: 8px;
            align-items: center;
        }

        .amount-label,
        .change-amount {
            display: none;
        }
    }

    @@media (max-width: 599px) {
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .toggle-rounded {
            width: 100%;
        }
    }
</style>

@code {
    [CascadingParameter(Name = "IsDarkMode")]
    private bool IsDarkMode { get; set; } = true;

    private bool _isLoading = true;
    private bool _isLoadingChart = false;
    private string? _error;
    private string _selectedGranularity = "Monthly";
    private CancellationTokenSource? _cts;

    private DashboardKpis? _kpis;
    private StackedTimeSeries? _stackedTimeSeries;
    private StreamHealthSummary? _streamHealth;

    // ApexCharts data
    private ApexChart<ChartDataPoint>? _mainChart;
    private List<ChartSeriesData> _apexChartSeries = [];
    private List<SparklinePoint> _sparklineData = [];
    private List<DonutDataPoint> _donutData = [];
    private Dictionary<string, string> _streamColorMap = [];

    // Theme-aware colors
    private string AxisLabelColor => IsDarkMode ? "#94a3b8" : "#64748b";
    private string GridColor => IsDarkMode ? "#334155" : "#e2e8f0";
    private Mode TooltipTheme => IsDarkMode ? Mode.Dark : Mode.Light;
    private string[] ChartColors => IsDarkMode
        ? ["#818cf8", "#34d399", "#fbbf24", "#f472b6", "#60a5fa", "#2dd4bf", "#a78bfa", "#fb923c", "#4ade80", "#38bdf8"]
        : ["#6366f1", "#10b981", "#f59e0b", "#ec4899", "#3b82f6", "#14b8a6", "#8b5cf6", "#f97316", "#22c55e", "#0ea5e9"];

    // Chart options - built dynamically
    private ApexChartOptions<ChartDataPoint> _areaChartOptions = null!;
    private ApexChartOptions<SparklinePoint> _sparklineOptions = null!;
    private ApexChartOptions<DonutDataPoint> _donutChartOptions = null!;

    private void BuildChartOptions()
    {
        _areaChartOptions = new ApexChartOptions<ChartDataPoint>
        {
            Chart = new Chart
            {
                Stacked = true,
                Toolbar = new Toolbar { Show = false },
                Background = "transparent",
                Animations = new Animations
                {
                    Enabled = true,
                    Speed = 400,
                    AnimateGradually = new AnimateGradually { Enabled = true, Delay = 50 }
                }
            },
            PlotOptions = new PlotOptions
            {
                Bar = new PlotOptionsBar
                {
                    BorderRadius = 4,
                    ColumnWidth = "60%"
                }
            },
            Xaxis = new XAxis
            {
                Labels = new XAxisLabels
                {
                    Style = new AxisLabelStyle { Colors = new List<string> { AxisLabelColor } }
                }
            },
            Yaxis =
            [
                new YAxis
                {
                    Labels = new YAxisLabels
                    {
                        Style = new AxisLabelStyle { Colors = new List<string> { AxisLabelColor } },
                        Formatter = "function(val) { return '$' + val.toLocaleString(); }"
                    }
                }
            ],
            DataLabels = new DataLabels { Enabled = false },
            Legend = new Legend { Show = true, Position = LegendPosition.Top, Labels = new LegendLabels { Colors = new ApexCharts.Color(AxisLabelColor) } },
            Grid = new Grid
            {
                BorderColor = GridColor,
                StrokeDashArray = 4
            },
            Tooltip = new Tooltip
            {
                Theme = TooltipTheme,
                Y = new TooltipY { Formatter = "function(val) { return '$' + val.toLocaleString(); }" }
            },
            Colors = ChartColors.ToList()
        };

        _sparklineOptions = new ApexChartOptions<SparklinePoint>
        {
            Chart = new Chart
            {
                Sparkline = new ChartSparkline { Enabled = true },
                Background = "transparent"
            },
            Stroke = new Stroke { Curve = Curve.Smooth, Width = 2 },
            Fill = new Fill
            {
                Type = new List<FillType> { FillType.Gradient },
                Gradient = new FillGradient
                {
                    ShadeIntensity = 1,
                    OpacityFrom = 0.4,
                    OpacityTo = 0.1
                }
            },
            Colors = ["#ffffff"],
            Tooltip = new Tooltip { Enabled = false }
        };

        _donutChartOptions = new ApexChartOptions<DonutDataPoint>
        {
            Chart = new Chart
            {
                Toolbar = new Toolbar { Show = false },
                Background = "transparent"
            },
            Legend = new Legend { Show = false },
            DataLabels = new DataLabels { Enabled = false },
            PlotOptions = new PlotOptions
            {
                Pie = new PlotOptionsPie
                {
                    Donut = new PlotOptionsDonut
                    {
                        Size = "70%",
                        Labels = new DonutLabels
                        {
                            Show = true,
                            Total = new DonutLabelTotal
                            {
                                Show = true,
                                Label = "Total",
                                Color = AxisLabelColor,
                                Formatter = "function(w) { return '$' + w.globals.seriesTotals.reduce((a, b) => a + b, 0).toLocaleString(); }"
                            },
                            Value = new DonutLabelValue { Color = IsDarkMode ? "#f1f5f9" : "#0f172a" }
                        }
                    }
                }
            },
            Tooltip = new Tooltip
            {
                Theme = TooltipTheme,
                Y = new TooltipY { Formatter = "function(val) { return '$' + val.toLocaleString(); }" }
            },
            Colors = ChartColors.ToList()
        };
    }

    // Data classes
    public class ChartDataPoint
    {
        public string Date { get; set; } = "";
        public decimal Amount { get; set; }
    }

    public class ChartSeriesData
    {
        public string Name { get; set; } = "";
        public List<ChartDataPoint> Data { get; set; } = [];
    }

    public class SparklinePoint
    {
        public string Label { get; set; } = "";
        public decimal Value { get; set; }
    }

    public class DonutDataPoint
    {
        public string Label { get; set; } = "";
        public decimal Value { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        BuildChartOptions();
        await LoadDataAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _cts = new CancellationTokenSource();
            _ = StartAutoRefreshAsync(_cts.Token);
        }
    }

    private async Task StartAutoRefreshAsync(CancellationToken ct)
    {
        using var timer = new PeriodicTimer(TimeSpan.FromSeconds(10));
        try
        {
            while (await timer.WaitForNextTickAsync(ct))
            {
                await LoadDataAsync(silentRefresh: true);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (OperationCanceledException)
        {
            // Expected when disposed
        }
    }

    protected override void OnParametersSet()
    {
        BuildChartOptions();
    }

    private async Task LoadDataAsync(bool silentRefresh = false)
    {
        try
        {
            if (!silentRefresh) _isLoading = true;

            var kpisResult = await DashboardService.GetKpisAsync();
            if (kpisResult.IsSuccess) _kpis = kpisResult.Value;

            var stackedResult = await DashboardService.GetStackedTimeSeriesAsync(_selectedGranularity, 180);
            if (stackedResult.IsSuccess)
            {
                _stackedTimeSeries = stackedResult.Value;
                PrepareCharts();
            }

            var healthResult = await DashboardService.GetStreamHealthAsync("MoM");
            if (healthResult.IsSuccess) _streamHealth = healthResult.Value;
        }
        catch (Exception ex)
        {
            if (!silentRefresh) _error = $"Error loading dashboard: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnGranularityChanged(string value)
    {
        _selectedGranularity = value;
        _isLoadingChart = true;
        StateHasChanged();

        try
        {
            var stackedResult = await DashboardService.GetStackedTimeSeriesAsync(_selectedGranularity, 180);
            if (stackedResult.IsSuccess)
            {
                _stackedTimeSeries = stackedResult.Value;
                PrepareCharts();
            }
        }
        finally
        {
            _isLoadingChart = false;
        }
    }

    private void PrepareCharts()
    {
        if (_stackedTimeSeries?.Points is null || _stackedTimeSeries.Points.Count == 0) return;

        var streamNames = _stackedTimeSeries.StreamNames.ToList();

        // Build color map
        _streamColorMap = streamNames
            .Select((name, i) => (name, ChartColors[i % ChartColors.Length]))
            .ToDictionary(x => x.name, x => x.Item2);

        // Prepare main chart series
        _apexChartSeries = streamNames.Select(streamName => new ChartSeriesData
        {
            Name = streamName,
            Data = _stackedTimeSeries.Points.Select(p => new ChartDataPoint
            {
                Date = FormatDateLabel(p.Date, _selectedGranularity),
                Amount = p.Streams.FirstOrDefault(s => s.StreamName == streamName)?.AmountUsd ?? 0
            }).ToList()
        }).ToList();

        // Prepare sparkline (last 7 data points of total)
        _sparklineData = _stackedTimeSeries.Points
            .TakeLast(7)
            .Select(p => new SparklinePoint
            {
                Label = FormatDateLabel(p.Date, _selectedGranularity),
                Value = p.Streams.Sum(s => s.AmountUsd)
            })
            .ToList();

        // Prepare donut chart (totals by stream)
        _donutData = streamNames.Select(streamName => new DonutDataPoint
        {
            Label = streamName,
            Value = _stackedTimeSeries.Points
                .SelectMany(p => p.Streams)
                .Where(s => s.StreamName == streamName)
                .Sum(s => s.AmountUsd)
        }).Where(d => d.Value > 0).ToList();
    }

    private string GetStreamColor(string streamName) =>
        _streamColorMap.TryGetValue(streamName, out var color) ? color : "#64748b";

    private static string FormatDateLabel(DateOnly date, string granularity) => granularity switch
    {
        "Daily" => date.ToString("MMM dd"),
        "Weekly" => $"W{GetWeekNumber(date)}",
        "Monthly" => date.ToString("MMM yy"),
        _ => date.ToString("MMM dd")
    };

    private static int GetWeekNumber(DateOnly date)
    {
        var jan1 = new DateOnly(date.Year, 1, 1);
        return (date.DayNumber - jan1.DayNumber) / 7 + 1;
    }

    private static string FormatCurrency(decimal amount) =>
        amount.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("en-US"));

    private static string FormatSignedCurrency(decimal amount) =>
        (amount >= 0 ? "+" : "") + amount.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("en-US"));

    private static string FormatSignedPercentage(decimal percentage) =>
        $"{(percentage >= 0 ? "+" : "")}{percentage:F1}%";

    private static string GetTrendGradientClass(string? direction) => direction switch
    {
        "Upward" => "gradient-success",
        "Downward" => "gradient-error",
        _ => "gradient-dark"
    };

    private static string GetTrendArrowIcon(string? direction) => direction switch
    {
        "Upward" => Icons.Material.Rounded.TrendingUp,
        "Downward" => Icons.Material.Rounded.TrendingDown,
        _ => Icons.Material.Rounded.TrendingFlat
    };

    private static string GetDirectionIcon(string? direction) => direction switch
    {
        "Upward" => Icons.Material.Rounded.ArrowUpward,
        "Downward" => Icons.Material.Rounded.ArrowDownward,
        _ => Icons.Material.Rounded.Remove
    };

    private static Color GetDirectionColor(string? direction) => direction switch
    {
        "Upward" => Color.Success,
        "Downward" => Color.Error,
        _ => Color.Default
    };

    private static string GetCategoryClass(string? category) => $"category-{category?.ToLower() ?? "default"}";

    private static string GetChangeClass(string? direction) => direction switch
    {
        "Upward" => "change-up",
        "Downward" => "change-down",
        _ => "change-flat"
    };

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }
}
