@page "/"
@using Analytics.Application.Services
@inject IDashboardService DashboardService
@rendermode InteractiveServer

<PageTitle>FlowMetrics - Income Dashboard</PageTitle>

<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <p class="page-subtitle">Your financial overview at a glance</p>
</div>

@if (_isLoading)
{
    <div class="loading-container">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-3">Loading your dashboard...</MudText>
    </div>
}
else if (_error is not null)
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4 animate-fade-in">@_error</MudAlert>
}
else
{
    <!-- THE 3 KEY QUESTIONS -->
    <div class="kpi-grid animate-slide-up">
        <!-- WHERE AM I? -->
        <div class="stat-card gradient-primary hover-lift">
            <div class="stat-card-icon">
                <MudIcon Icon="@Icons.Material.Rounded.Speed" Size="Size.Large" />
            </div>
            <div class="stat-card-label">Where am I?</div>
            <div class="stat-card-value">
                @FormatCurrency(_kpis?.DailyRate.AverageDailyUsd ?? 0)<span class="stat-card-unit">/day</span>
            </div>
            <div class="stat-card-subtitle">
                avg last @(_kpis?.DailyRate.DaysAnalyzed ?? 30) days
            </div>
            @if (_kpis?.DailyRate.StandardDeviation > 0)
            {
                <div class="stat-card-meta">
                    <MudIcon Icon="@Icons.Material.Rounded.ShowChart" Size="Size.Small" />
                    <span>@FormatCurrency(_kpis.DailyRate.StandardDeviation) volatility</span>
                </div>
            }
        </div>

        <!-- WHERE AM I GOING? -->
        <div class="stat-card @GetTrendGradientClass(_kpis?.Trend.Direction) hover-lift">
            <div class="stat-card-icon">
                <MudIcon Icon="@GetTrendArrowIcon(_kpis?.Trend.Direction)" Size="Size.Large" />
            </div>
            <div class="stat-card-label">Where am I going?</div>
            <div class="stat-card-value">
                @FormatSignedPercentage(_kpis?.Trend.ChangePercentage ?? 0)
            </div>
            <div class="stat-card-subtitle">
                @(_kpis?.Trend.ComparisonPeriod ?? "vs last month")
            </div>
            <div class="stat-card-meta">
                <MudIcon Icon="@Icons.Material.Rounded.Timeline" Size="Size.Small" />
                <span>@(_kpis?.Trend.Direction ?? "Stable") trend</span>
            </div>
        </div>

        <!-- WHERE WILL I BE? -->
        <div class="stat-card gradient-purple hover-lift">
            <div class="stat-card-icon">
                <MudIcon Icon="@Icons.Material.Rounded.RocketLaunch" Size="Size.Large" />
            </div>
            <div class="stat-card-label">Where will I be?</div>
            <div class="stat-card-value">
                @FormatCurrency(_kpis?.Projection.Projected6MonthTotalUsd ?? 0)
            </div>
            <div class="stat-card-subtitle">
                projected in 6 months
            </div>
            <div class="confidence-bar">
                <span class="confidence-label">Confidence</span>
                <div class="confidence-track">
                    <div class="confidence-fill" style="width: @((_kpis?.Projection.ConfidenceScore ?? 0) * 100)%"></div>
                </div>
                <span class="confidence-value">@(((_kpis?.Projection.ConfidenceScore ?? 0) * 100).ToString("F0"))%</span>
            </div>
        </div>
    </div>

    <!-- INCOME OVER TIME -->
    <div class="card-modern mt-6 animate-slide-up" style="animation-delay: 0.1s;">
        <div class="section-header">
            <div>
                <h2 class="section-title">Income Over Time</h2>
                <p class="page-subtitle" style="margin-top: 4px;">Track your earnings progression</p>
            </div>
            <MudToggleGroup T="string" Value="_selectedGranularity" ValueChanged="OnGranularityChanged" Color="Color.Primary" CheckMark="false" Class="toggle-rounded">
                <MudToggleItem Value="@("Daily")">Daily</MudToggleItem>
                <MudToggleItem Value="@("Weekly")">Weekly</MudToggleItem>
                <MudToggleItem Value="@("Monthly")">Monthly</MudToggleItem>
            </MudToggleGroup>
        </div>

        @if (_isLoadingChart)
        {
            <div style="display: flex; justify-content: center; padding: 60px 0;">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
        else if (_stackedTimeSeries?.Points.Count > 0)
        {
            <!-- Stacked Bar Chart - Total Income -->
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">Total Income (Stacked)</MudText>
            <MudChart ChartType="ChartType.StackedBar"
                      ChartSeries="@_stackedChartSeries"
                      XAxisLabels="@_stackedChartLabels"
                      Width="100%"
                      Height="280px"
                      ChartOptions="@_chartOptions" />

            <!-- Line Chart - Individual Stream Trends -->
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mt-6 mb-2">Individual Stream Trends</MudText>
            <MudChart ChartType="ChartType.Line"
                      ChartSeries="@_stackedChartSeries"
                      XAxisLabels="@_stackedChartLabels"
                      Width="100%"
                      Height="280px"
                      ChartOptions="@_lineChartOptions" />

            <!-- Modern Legend -->
            <div class="chart-legend">
                @foreach (var (name, color) in _streamColors)
                {
                    <div class="legend-item">
                        <span class="legend-dot" style="background-color: @color;"></span>
                        <span class="legend-label">@name</span>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-state-icon">
                    <MudIcon Icon="@Icons.Material.Rounded.BarChart" Size="Size.Large" Color="Color.Secondary" />
                </div>
                <MudText Typo="Typo.h6">No income data yet</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Add income streams and record snapshots to see your trends</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" Href="/streams" StartIcon="@Icons.Material.Rounded.Add">
                    Add Stream
                </MudButton>
            </div>
        }
    </div>

    <!-- STREAM HEALTH -->
    <div class="card-modern mt-6 animate-slide-up" style="animation-delay: 0.2s;">
        <div class="section-header">
            <div>
                <h2 class="section-title">Stream Health</h2>
                <p class="page-subtitle" style="margin-top: 4px;">Performance by income source</p>
            </div>
            <div class="health-badges">
                <div class="health-badge health-badge-success">
                    <MudIcon Icon="@Icons.Material.Rounded.TrendingUp" Size="Size.Small" />
                    <span>@(_streamHealth?.GrowingCount ?? 0) Growing</span>
                </div>
                <div class="health-badge health-badge-neutral">
                    <MudIcon Icon="@Icons.Material.Rounded.TrendingFlat" Size="Size.Small" />
                    <span>@(_streamHealth?.StableCount ?? 0) Stable</span>
                </div>
                <div class="health-badge health-badge-error">
                    <MudIcon Icon="@Icons.Material.Rounded.TrendingDown" Size="Size.Small" />
                    <span>@(_streamHealth?.DecliningCount ?? 0) Declining</span>
                </div>
            </div>
        </div>

        @if (_streamHealth?.Streams.Count > 0)
        {
            <div class="stream-list">
                @foreach (var stream in _streamHealth.Streams)
                {
                    <div class="stream-item">
                        <div class="stream-info">
                            <div class="stream-avatar @GetCategoryClass(stream.Category)">
                                @stream.StreamName[0]
                            </div>
                            <div class="stream-details">
                                <span class="stream-name">@stream.StreamName</span>
                                <span class="stream-provider">@stream.ProviderName</span>
                            </div>
                        </div>
                        <div class="stream-category">
                            <span class="category-chip @GetCategoryClass(stream.Category)">@stream.Category</span>
                        </div>
                        <div class="stream-trend">
                            <MudIcon Icon="@GetDirectionIcon(stream.Direction)"
                                     Color="@GetDirectionColor(stream.Direction)"
                                     Size="Size.Small" />
                        </div>
                        <div class="stream-amount">
                            <span class="amount-value">@FormatCurrency(stream.CurrentPeriodUsd)</span>
                            <span class="amount-label">this period</span>
                        </div>
                        <div class="stream-change @GetChangeClass(stream.Direction)">
                            <span class="change-percent">@FormatSignedPercentage(stream.ChangePercentage)</span>
                            <span class="change-amount">@FormatSignedCurrency(stream.ChangeUsd)</span>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-state-icon">
                    <MudIcon Icon="@Icons.Material.Rounded.Assessment" Size="Size.Large" Color="Color.Secondary" />
                </div>
                <MudText Typo="Typo.h6">No streams to analyze</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Add your first income stream to track its performance</MudText>
            </div>
        }
    </div>
}

<style>
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
    }

    @@media (max-width: 1279px) {
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 767px) {
        .kpi-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }
    }

    .stat-card {
        position: relative;
        padding: 28px;
        border-radius: 20px;
        color: white;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        pointer-events: none;
    }

    .stat-card-icon {
        position: absolute;
        top: 20px;
        right: 20px;
        opacity: 0.3;
    }

    .stat-card-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        opacity: 0.85;
        margin-bottom: 12px;
    }

    .stat-card-value {
        font-size: 2.25rem;
        font-weight: 700;
        line-height: 1.1;
        margin-bottom: 4px;
    }

    .stat-card-unit {
        font-size: 0.5em;
        opacity: 0.75;
        font-weight: 500;
    }

    .stat-card-subtitle {
        font-size: 0.875rem;
        opacity: 0.75;
        margin-bottom: 16px;
    }

    .stat-card-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        opacity: 0.65;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.15);
    }

    .confidence-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.15);
    }

    .confidence-label {
        font-size: 0.75rem;
        opacity: 0.65;
    }

    .confidence-track {
        flex: 1;
        height: 6px;
        background: rgba(255,255,255,0.2);
        border-radius: 3px;
        overflow: hidden;
    }

    .confidence-fill {
        height: 100%;
        background: rgba(255,255,255,0.8);
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .confidence-value {
        font-size: 0.75rem;
        font-weight: 600;
    }

    .chart-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid var(--mud-palette-divider);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 3px;
    }

    .legend-label {
        font-size: 0.8125rem;
        color: var(--mud-palette-text-secondary);
    }

    .health-badges {
        display: flex;
        gap: 12px;
    }

    .health-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8125rem;
        font-weight: 500;
    }

    .health-badge-success {
        background: rgba(16, 185, 129, 0.15);
        color: var(--mud-palette-success);
    }

    .health-badge-neutral {
        background: var(--mud-palette-divider);
        color: var(--mud-palette-text-secondary);
    }

    .health-badge-error {
        background: rgba(239, 68, 68, 0.15);
        color: var(--mud-palette-error);
    }

    .stream-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .stream-item {
        display: grid;
        grid-template-columns: 2fr 1fr 60px 1fr 1fr;
        align-items: center;
        padding: 16px;
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    .stream-item:hover {
        border-color: var(--mud-palette-primary);
        transform: translateX(4px);
    }

    .stream-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .stream-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
        color: white;
    }

    .stream-avatar.category-salary { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    .stream-avatar.category-trading { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .stream-avatar.category-subscription { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .stream-avatar.category-referral { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .stream-avatar.category-default { background: linear-gradient(135deg, #64748b 0%, #475569 100%); }

    .stream-details {
        display: flex;
        flex-direction: column;
    }

    .stream-name {
        font-weight: 600;
        font-size: 0.9375rem;
    }

    .stream-provider {
        font-size: 0.8125rem;
        color: var(--mud-palette-text-secondary);
    }

    .category-chip {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .category-chip.category-salary { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
    .category-chip.category-trading { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
    .category-chip.category-subscription { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
    .category-chip.category-referral { background: rgba(16, 185, 129, 0.15); color: #34d399; }
    .category-chip.category-default { background: var(--mud-palette-divider); color: var(--mud-palette-text-secondary); }

    .stream-trend {
        display: flex;
        justify-content: center;
    }

    .stream-amount {
        display: flex;
        flex-direction: column;
        text-align: right;
    }

    .amount-value {
        font-weight: 600;
        font-size: 0.9375rem;
    }

    .amount-label {
        font-size: 0.75rem;
        color: var(--mud-palette-text-secondary);
    }

    .stream-change {
        display: flex;
        flex-direction: column;
        text-align: right;
    }

    .stream-change.change-up { color: var(--mud-palette-success); }
    .stream-change.change-down { color: var(--mud-palette-error); }
    .stream-change.change-flat { color: var(--mud-palette-text-secondary); }

    .change-percent {
        font-weight: 600;
        font-size: 0.9375rem;
    }

    .change-amount {
        font-size: 0.75rem;
        opacity: 0.75;
    }

    .toggle-rounded {
        border-radius: 10px;
        overflow: hidden;
    }

    @@media (max-width: 1279px) {
        .stream-item {
            grid-template-columns: 2fr 1fr 1fr;
        }

        .stream-category {
            display: none;
        }
    }

    @@media (max-width: 767px) {
        .health-badges {
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .health-badge {
            padding: 4px 10px;
            font-size: 0.75rem;
        }

        .stream-item {
            grid-template-columns: 1fr;
            gap: 12px;
            padding: 14px;
        }

        .stream-category,
        .stream-trend {
            display: none;
        }

        .stream-info {
            flex: 1;
        }

        .stream-amount,
        .stream-change {
            text-align: left;
            flex-direction: row;
            gap: 8px;
            align-items: center;
        }

        .amount-label,
        .change-amount {
            display: none;
        }
    }

    @@media (max-width: 599px) {
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .toggle-rounded {
            width: 100%;
        }

        .chart-legend {
            gap: 12px;
        }

        .legend-item {
            font-size: 0.75rem;
        }
    }
</style>

@code {
    private bool _isLoading = true;
    private bool _isLoadingChart = false;
    private string? _error;
    private string _selectedGranularity = "Monthly";

    private DashboardKpis? _kpis;
    private StackedTimeSeries? _stackedTimeSeries;
    private StreamHealthSummary? _streamHealth;

    private List<ChartSeries> _stackedChartSeries = [];
    private string[] _stackedChartLabels = [];
    private ChartOptions _chartOptions = new() { YAxisTicks = 500, InterpolationOption = InterpolationOption.Straight };
    private ChartOptions _lineChartOptions = new() { YAxisTicks = 500, InterpolationOption = InterpolationOption.Straight, LineStrokeWidth = 2 };
    private List<(string Name, string Color)> _streamColors = [];

    private static readonly string[] ChartColors = [
        "#818cf8", "#34d399", "#fbbf24", "#f472b6", "#60a5fa",
        "#2dd4bf", "#a78bfa", "#fb923c", "#4ade80", "#38bdf8"
    ];

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _isLoading = true;

            var kpisResult = await DashboardService.GetKpisAsync();
            if (kpisResult.IsSuccess) _kpis = kpisResult.Value;

            var stackedResult = await DashboardService.GetStackedTimeSeriesAsync(_selectedGranularity, 180);
            if (stackedResult.IsSuccess)
            {
                _stackedTimeSeries = stackedResult.Value;
                PrepareStackedChart();
            }

            var healthResult = await DashboardService.GetStreamHealthAsync("MoM");
            if (healthResult.IsSuccess) _streamHealth = healthResult.Value;
        }
        catch (Exception ex)
        {
            _error = $"Error loading dashboard: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnGranularityChanged(string value)
    {
        _selectedGranularity = value;
        _isLoadingChart = true;
        StateHasChanged();

        try
        {
            var stackedResult = await DashboardService.GetStackedTimeSeriesAsync(_selectedGranularity, 180);
            if (stackedResult.IsSuccess)
            {
                _stackedTimeSeries = stackedResult.Value;
                PrepareStackedChart();
            }
        }
        finally
        {
            _isLoadingChart = false;
        }
    }

    private void PrepareStackedChart()
    {
        if (_stackedTimeSeries?.Points is null || _stackedTimeSeries.Points.Count == 0) return;

        var streamNames = _stackedTimeSeries.StreamNames.ToList();
        _streamColors = streamNames.Select((name, i) => (name, ChartColors[i % ChartColors.Length])).ToList();

        _stackedChartLabels = _stackedTimeSeries.Points
            .Select(p => FormatDateLabel(p.Date, _selectedGranularity))
            .ToArray();

        _stackedChartSeries = streamNames.Select((streamName, index) => new ChartSeries
        {
            Name = streamName,
            Data = _stackedTimeSeries.Points
                .Select(p => (double)(p.Streams.FirstOrDefault(s => s.StreamName == streamName)?.AmountUsd ?? 0))
                .ToArray()
        }).ToList();
    }

    private static string FormatDateLabel(DateOnly date, string granularity) => granularity switch
    {
        "Daily" => date.ToString("MMM dd"),
        "Weekly" => $"W{GetWeekNumber(date)}",
        "Monthly" => date.ToString("MMM yy"),
        _ => date.ToString("MMM dd")
    };

    private static int GetWeekNumber(DateOnly date)
    {
        var jan1 = new DateOnly(date.Year, 1, 1);
        return (date.DayNumber - jan1.DayNumber) / 7 + 1;
    }

    private static string FormatCurrency(decimal amount) =>
        amount.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("en-US"));

    private static string FormatSignedCurrency(decimal amount) =>
        (amount >= 0 ? "+" : "") + amount.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("en-US"));

    private static string FormatSignedPercentage(decimal percentage) =>
        $"{(percentage >= 0 ? "+" : "")}{percentage:F1}%";

    private static string GetTrendGradientClass(string? direction) => direction switch
    {
        "Upward" => "gradient-success",
        "Downward" => "gradient-error",
        _ => "gradient-dark"
    };

    private static string GetTrendArrowIcon(string? direction) => direction switch
    {
        "Upward" => Icons.Material.Rounded.TrendingUp,
        "Downward" => Icons.Material.Rounded.TrendingDown,
        _ => Icons.Material.Rounded.TrendingFlat
    };

    private static string GetDirectionIcon(string? direction) => direction switch
    {
        "Upward" => Icons.Material.Rounded.ArrowUpward,
        "Downward" => Icons.Material.Rounded.ArrowDownward,
        _ => Icons.Material.Rounded.Remove
    };

    private static Color GetDirectionColor(string? direction) => direction switch
    {
        "Upward" => Color.Success,
        "Downward" => Color.Error,
        _ => Color.Default
    };

    private static string GetCategoryClass(string? category) => $"category-{category?.ToLower() ?? "default"}";

    private static string GetChangeClass(string? direction) => direction switch
    {
        "Upward" => "change-up",
        "Downward" => "change-down",
        _ => "change-flat"
    };
}
