@page "/projections"
@using Analytics.Application.Services
@inject IGetProjectionHandler ProjectionHandler
@inject IDashboardService DashboardService
@rendermode InteractiveServer

<PageTitle>Projections - FlowMetrics</PageTitle>

<div class="page-header">
    <h1 class="page-title">Where Will I Be?</h1>
    <p class="page-subtitle">Income projections and goal planning</p>
</div>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
}
else if (_projection is null)
{
    <MudAlert Severity="Severity.Warning">
        Unable to generate projections. Add more income data to see forecasts.
    </MudAlert>
}
else
{
    <!-- The Big Number - 6 Month Projection -->
    <MudPaper Class="pa-4 pa-sm-6 mb-4" Elevation="3" Style="background: linear-gradient(135deg, #4a148c 0%, #6a1b9a 100%);">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.overline" Style="color: rgba(255,255,255,0.7);">
                        PROJECTED TOTAL IN 6 MONTHS
                    </MudText>
                    <MudText Typo="Typo.h3" Class="projection-big-number" Style="color: white; font-weight: 700;">
                        @FormatCurrency(_projection.Projected6MonthTotalUsd)
                    </MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="flex-wrap">
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.7);">
                            Confidence:
                        </MudText>
                        <MudProgressLinear Value="@((double)(_projection.ConfidenceScore * 100))"
                                           Color="@GetConfidenceColor(_projection.ConfidenceScore)"
                                           Style="width: 80px; height: 8px; flex-shrink: 0;" />
                        <MudText Typo="Typo.body2" Style="color: white; font-weight: 600;">
                            @((_projection.ConfidenceScore * 100).ToString("F0"))%
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudStack Row="true" Justify="Justify.SpaceBetween" Class="projection-rates" AlignItems="AlignItems.Center">
                    <MudStack AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.6);">Monthly</MudText>
                        <MudText Typo="Typo.h5" Class="rate-value" Style="color: white;">
                            @FormatCurrency(_projection.ProjectedMonthlyIncomeUsd)
                        </MudText>
                    </MudStack>
                    <MudStack AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.6);">Annual</MudText>
                        <MudText Typo="Typo.h5" Class="rate-value" Style="color: white;">
                            @FormatCurrency(_projection.ProjectedAnnualIncomeUsd)
                        </MudText>
                    </MudStack>
                    <MudStack AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.6);">Daily</MudText>
                        <MudText Typo="Typo.h5" Class="rate-value" Style="color: white;">
                            @FormatCurrency(_kpis?.DailyRate.AverageDailyUsd ?? 0)
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Time to Goal Calculator -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h6">Time to Goal</MudText>
            <MudTextField T="decimal" Value="_goalAmount" ValueChanged="OnGoalAmountChanged"
                          Label="Target Amount"
                          Variant="Variant.Outlined" Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                          Immediate="true" DebounceInterval="300"
                          Style="max-width: 200px;" />
        </MudStack>

        @if (_goalAmount > 0 && _projection is not null && _projection.ProjectedMonthlyIncomeUsd > 0)
        {
            var scenarios = CalculateGoalScenarios(_goalAmount);

            <MudGrid Spacing="3">
                <!-- Pessimistic Scenario -->
                <MudItem xs="12" md="4">
                    <MudPaper Class="pa-4 scenario-card" Elevation="0"
                              Style="background: linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(239,68,68,0.05) 100%); border: 1px solid rgba(239,68,68,0.3);">
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Color="Color.Error" Size="Size.Small" />
                                <MudText Typo="Typo.overline" Color="Color.Error">PESSIMISTIC</MudText>
                            </MudStack>
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@scenarios.Pessimistic.Months months</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@scenarios.Pessimistic.TargetDate.ToString("MMMM yyyy")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@FormatCurrency(scenarios.Pessimistic.MonthlyRate)/mo</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <!-- Realistic Scenario -->
                <MudItem xs="12" md="4">
                    <MudPaper Class="pa-4 scenario-card" Elevation="0"
                              Style="background: linear-gradient(135deg, rgba(99,102,241,0.15) 0%, rgba(99,102,241,0.05) 100%); border: 2px solid rgba(99,102,241,0.5);">
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.TrendingFlat" Color="Color.Primary" Size="Size.Small" />
                                <MudText Typo="Typo.overline" Color="Color.Primary">REALISTIC</MudText>
                            </MudStack>
                            <MudText Typo="Typo.h4" Color="Color.Primary" Style="font-weight: 700;">@scenarios.Realistic.Months months</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@scenarios.Realistic.TargetDate.ToString("MMMM yyyy")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@FormatCurrency(scenarios.Realistic.MonthlyRate)/mo</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <!-- Optimistic Scenario -->
                <MudItem xs="12" md="4">
                    <MudPaper Class="pa-4 scenario-card" Elevation="0"
                              Style="background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.05) 100%); border: 1px solid rgba(16,185,129,0.3);">
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Success" Size="Size.Small" />
                                <MudText Typo="Typo.overline" Color="Color.Success">OPTIMISTIC</MudText>
                            </MudStack>
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@scenarios.Optimistic.Months months</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@scenarios.Optimistic.TargetDate.ToString("MMMM yyyy")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@FormatCurrency(scenarios.Optimistic.MonthlyRate)/mo</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <!-- Goal Progress Chart -->
            <MudPaper Class="pa-4 mt-4" Elevation="0" Style="@($"background-color: {(IsDarkMode ? "rgba(30,41,59,0.5)" : "rgba(241,245,249,0.8)")}; border-radius: 8px;")">
                <MudText Typo="Typo.subtitle2" Class="mb-3">Path to @FormatCurrency(_goalAmount)</MudText>
                @if (_goalProgressData.Count > 0)
                {
                    <ApexChart @key="@($"goal_{_goalAmount}_{IsDarkMode}")"
                               TItem="GoalProgressPoint"
                               Options="_goalChartOptions"
                               Height="200">
                        <ApexPointSeries TItem="GoalProgressPoint"
                                         Items="_goalProgressData"
                                         Name="Projected"
                                         SeriesType="SeriesType.Area"
                                         XValue="@(p => p.Month)"
                                         YValue="@(p => p.Cumulative)" />
                        <ApexPointSeries TItem="GoalProgressPoint"
                                         Items="_goalProgressData"
                                         Name="Goal"
                                         SeriesType="SeriesType.Line"
                                         XValue="@(p => p.Month)"
                                         YValue="@(p => _goalAmount)" />
                    </ApexChart>
                }

                <!-- Probability Insight -->
                <MudStack Row="true" Justify="Justify.Center" AlignItems="AlignItems.Center" Spacing="2" Class="mt-3">
                    <MudIcon Icon="@Icons.Material.Filled.QueryStats" Color="Color.Info" />
                    <MudText Typo="Typo.body2">
                        Based on your income variability, you have a
                        <strong style="color: var(--mud-palette-primary);">@CalculateGoalProbability(scenarios)%</strong>
                        chance of reaching this goal within @scenarios.Realistic.Months months.
                    </MudText>
                </MudStack>
            </MudPaper>
        }
        else
        {
            <MudPaper Class="pa-6" Elevation="0" Style="@($"background-color: {(IsDarkMode ? "rgba(30,41,59,0.5)" : "rgba(241,245,249,0.8)")}; border-radius: 8px; text-align: center;")">
                <MudIcon Icon="@Icons.Material.Filled.Flag" Size="Size.Large" Color="Color.Secondary" Class="mb-2" />
                <MudText Color="Color.Secondary">Enter a target amount to see when you'll reach it</MudText>
            </MudPaper>
        }
    </MudPaper>

    <!-- Income Composition -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2" Style="height: 100%;">
                <MudText Typo="Typo.h6" Class="mb-3">Income Stability</MudText>
                @if (_compositionDonutData.Count > 0)
                {
                    <ApexChart @key="@($"composition_{IsDarkMode}")"
                               TItem="CompositionPoint"
                               Options="_donutChartOptions"
                               Height="200">
                        <ApexPointSeries TItem="CompositionPoint"
                                         Items="_compositionDonutData"
                                         SeriesType="SeriesType.Donut"
                                         XValue="@(p => p.Label)"
                                         YValue="@(p => p.Value)"
                                         OrderBy="@(p => p.Y)" />
                    </ApexChart>
                }
                <MudStack Spacing="2" Class="mt-4">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Lock" Color="Color.Success" Size="Size.Small" />
                            <MudText Typo="Typo.body2">Fixed Income</MudText>
                        </MudStack>
                        <MudText Typo="Typo.h6" Color="Color.Success">
                            @FormatCurrency(_projection.FixedComponentUsd)
                        </MudText>
                    </MudStack>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.ShowChart" Color="Color.Warning" Size="Size.Small" />
                            <MudText Typo="Typo.body2">Variable Income</MudText>
                        </MudStack>
                        <MudText Typo="Typo.h6" Color="Color.Warning">
                            @FormatCurrency(_projection.VariableComponentUsd)
                        </MudText>
                    </MudStack>
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @if (_projection.ProjectedMonthlyIncomeUsd > 0)
                        {
                            var fixedPercent = (_projection.FixedComponentUsd / _projection.ProjectedMonthlyIncomeUsd * 100);
                            <span>@fixedPercent.ToString("F0")% of your income is predictable and stable.</span>
                        }
                    </MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2" Style="height: 100%;">
                <MudText Typo="Typo.h6" Class="mb-3">Confidence Analysis</MudText>
                <MudStack Spacing="3">
                    <div>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-1">
                            <MudText Typo="Typo.body2">Projection Confidence</MudText>
                            <MudText Typo="Typo.body2" Color="@GetConfidenceColor(_projection.ConfidenceScore)">
                                @GetConfidenceLabel(_projection.ConfidenceScore)
                            </MudText>
                        </MudStack>
                        <MudProgressLinear Value="@((double)(_projection.ConfidenceScore * 100))"
                                           Color="@GetConfidenceColor(_projection.ConfidenceScore)"
                                           Size="Size.Large" Rounded="true" />
                    </div>

                    <MudAlert Severity="@GetConfidenceSeverity(_projection.ConfidenceScore)" Dense="true">
                        <MudText Typo="Typo.body2">
                            @GetConfidenceDescription(_projection.ConfidenceScore)
                        </MudText>
                    </MudAlert>

                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Confidence is calculated based on:
                    </MudText>
                    <MudStack Spacing="1">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" />
                            <MudText Typo="Typo.caption">Fixed income ratio (50%)</MudText>
                        </MudStack>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Info" />
                            <MudText Typo="Typo.caption">Income variability (30%)</MudText>
                        </MudStack>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Warning" />
                            <MudText Typo="Typo.caption">Data quality (20%)</MudText>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- 12-Month Projection Chart -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-4">12-Month Forecast</MudText>

        @if (_projection.MonthlyProjections.Count > 0)
        {
            <ApexChart @key="@($"projection_{IsDarkMode}")"
                       TItem="ProjectionChartPoint"
                       Options="_projectionChartOptions"
                       Height="350">
                <ApexPointSeries TItem="ProjectionChartPoint"
                                 Items="_projectedSeries"
                                 Name="Projected"
                                 SeriesType="SeriesType.Area"
                                 XValue="@(p => p.Month)"
                                 YValue="@(p => p.Amount)" />
                <ApexPointSeries TItem="ProjectionChartPoint"
                                 Items="_upperBoundSeries"
                                 Name="Upper Bound"
                                 SeriesType="SeriesType.Line"
                                 XValue="@(p => p.Month)"
                                 YValue="@(p => p.Amount)" />
                <ApexPointSeries TItem="ProjectionChartPoint"
                                 Items="_lowerBoundSeries"
                                 Name="Lower Bound"
                                 SeriesType="SeriesType.Line"
                                 XValue="@(p => p.Month)"
                                 YValue="@(p => p.Amount)" />
            </ApexChart>
        }
    </MudPaper>

    <!-- Cumulative Projection -->
    <MudPaper Class="pa-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">Cumulative Income Milestones</MudText>

        <div class="table-responsive">
            <MudTable Items="@GetMilestones()" Dense="true" Hover="true" Elevation="0">
                <HeaderContent>
                    <MudTh>Timeframe</MudTh>
                    <MudTh Style="text-align:right">Cumulative Total</MudTh>
                    <MudTh Style="text-align:right" Class="hide-xs">Lower Estimate</MudTh>
                    <MudTh Style="text-align:right" Class="hide-xs">Upper Estimate</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.Label</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Date.ToString("MMM yy")</MudText>
                    </MudTd>
                    <MudTd Style="text-align:right">
                        <MudText Typo="Typo.subtitle1" Color="Color.Primary">@FormatCurrency(context.Cumulative)</MudText>
                    </MudTd>
                    <MudTd Style="text-align:right" Class="hide-xs">
                        <MudText Typo="Typo.body2" Color="Color.Error">@FormatCurrency(context.LowerBound)</MudText>
                    </MudTd>
                    <MudTd Style="text-align:right" Class="hide-xs">
                        <MudText Typo="Typo.body2" Color="Color.Success">@FormatCurrency(context.UpperBound)</MudText>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </div>
    </MudPaper>
}

<style>
    .projection-big-number {
        font-size: 2rem;
    }

    .projection-rates {
        height: 100%;
        padding-top: 16px;
    }

    .flex-wrap {
        flex-wrap: wrap;
    }

    @@media (min-width: 960px) {
        .projection-big-number {
            font-size: 2.5rem;
        }

        .rate-value {
            font-size: 1.5rem;
        }
    }

    @@media (max-width: 599px) {
        .projection-big-number {
            font-size: 1.75rem;
        }

        .projection-rates {
            justify-content: space-between !important;
            gap: 8px;
            padding-top: 12px;
        }

        .rate-value {
            font-size: 1rem !important;
        }
    }

    .scenario-card {
        border-radius: 12px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .scenario-card:hover {
        transform: translateY(-2px);
    }
</style>

@code {
    [CascadingParameter(Name = "IsDarkMode")]
    private bool IsDarkMode { get; set; } = true;

    private bool _isLoading = true;
    private ProjectionDto? _projection;
    private DashboardKpis? _kpis;
    private decimal _goalAmount = 0;

    // ApexCharts data
    private List<ProjectionChartPoint> _projectedSeries = [];
    private List<ProjectionChartPoint> _upperBoundSeries = [];
    private List<ProjectionChartPoint> _lowerBoundSeries = [];
    private List<CompositionPoint> _compositionDonutData = [];

    // Theme-aware colors
    private string AxisLabelColor => IsDarkMode ? "#94a3b8" : "#64748b";
    private string GridColor => IsDarkMode ? "#334155" : "#e2e8f0";
    private Mode TooltipTheme => IsDarkMode ? Mode.Dark : Mode.Light;

    // Chart data classes
    public class ProjectionChartPoint
    {
        public string Month { get; set; } = "";
        public decimal Amount { get; set; }
    }

    public class CompositionPoint
    {
        public string Label { get; set; } = "";
        public decimal Value { get; set; }
    }

    public class GoalProgressPoint
    {
        public string Month { get; set; } = "";
        public decimal Cumulative { get; set; }
    }

    // Goal scenario records
    private record GoalScenarioResult(int Months, DateTime TargetDate, decimal MonthlyRate);
    private record GoalScenarios(GoalScenarioResult Optimistic, GoalScenarioResult Realistic, GoalScenarioResult Pessimistic);

    // Goal progress data
    private List<GoalProgressPoint> _goalProgressData = [];

    // Chart options - built dynamically
    private ApexChartOptions<ProjectionChartPoint> _projectionChartOptions = null!;
    private ApexChartOptions<CompositionPoint> _donutChartOptions = null!;
    private ApexChartOptions<GoalProgressPoint> _goalChartOptions = null!;

    private void BuildChartOptions()
    {
        _projectionChartOptions = new ApexChartOptions<ProjectionChartPoint>
        {
            Chart = new Chart
            {
                Toolbar = new Toolbar { Show = false },
                Background = "transparent",
                Animations = new Animations { Enabled = true, Speed = 500 }
            },
            Stroke = new Stroke
            {
                Curve = Curve.Smooth,
                Width = new List<int> { 3, 2, 2 }
            },
            Fill = new Fill
            {
                Type = new List<FillType> { FillType.Gradient, FillType.Solid, FillType.Solid },
                Gradient = new FillGradient
                {
                    ShadeIntensity = 0.3,
                    OpacityFrom = 0.5,
                    OpacityTo = 0.1
                }
            },
            Xaxis = new XAxis
            {
                Labels = new XAxisLabels { Style = new AxisLabelStyle { Colors = new List<string> { AxisLabelColor } } }
            },
            Yaxis = [new YAxis
            {
                Labels = new YAxisLabels
                {
                    Style = new AxisLabelStyle { Colors = new List<string> { AxisLabelColor } },
                    Formatter = "function(val) { return '$' + val.toLocaleString(); }"
                }
            }],
            DataLabels = new DataLabels { Enabled = false },
            Legend = new Legend { Show = true, Position = LegendPosition.Top, Labels = new LegendLabels { Colors = new ApexCharts.Color(AxisLabelColor) } },
            Grid = new Grid { BorderColor = GridColor, StrokeDashArray = 4 },
            Tooltip = new Tooltip
            {
                Theme = TooltipTheme,
                Y = new TooltipY { Formatter = "function(val) { return '$' + val.toLocaleString(); }" }
            },
            Colors = IsDarkMode ? ["#818cf8", "#4ade80", "#f87171"] : ["#6366f1", "#10b981", "#ef4444"]
        };

        _donutChartOptions = new ApexChartOptions<CompositionPoint>
        {
            Chart = new Chart { Toolbar = new Toolbar { Show = false }, Background = "transparent" },
            Legend = new Legend { Show = false },
            DataLabels = new DataLabels { Enabled = false },
            PlotOptions = new PlotOptions
            {
                Pie = new PlotOptionsPie
                {
                    Donut = new PlotOptionsDonut
                    {
                        Size = "70%",
                        Labels = new DonutLabels
                        {
                            Show = true,
                            Total = new DonutLabelTotal
                            {
                                Show = true,
                                Label = "Monthly",
                                Color = AxisLabelColor,
                                Formatter = "function(w) { return '$' + w.globals.seriesTotals.reduce((a, b) => a + b, 0).toLocaleString(); }"
                            },
                            Value = new DonutLabelValue { Color = IsDarkMode ? "#f1f5f9" : "#0f172a" }
                        }
                    }
                }
            },
            Tooltip = new Tooltip
            {
                Theme = TooltipTheme,
                Y = new TooltipY { Formatter = "function(val) { return '$' + val.toLocaleString(); }" }
            },
            Colors = IsDarkMode ? ["#4ade80", "#fbbf24"] : ["#10b981", "#f59e0b"]
        };

        _goalChartOptions = new ApexChartOptions<GoalProgressPoint>
        {
            Chart = new Chart
            {
                Toolbar = new Toolbar { Show = false },
                Background = "transparent",
                Animations = new Animations { Enabled = true, Speed = 500 }
            },
            Stroke = new Stroke
            {
                Curve = Curve.Smooth,
                Width = new List<int> { 3, 2 },
                DashArray = new List<int> { 0, 5 }
            },
            Fill = new Fill
            {
                Type = new List<FillType> { FillType.Gradient, FillType.Solid },
                Gradient = new FillGradient
                {
                    ShadeIntensity = 0.3,
                    OpacityFrom = 0.4,
                    OpacityTo = 0.1
                }
            },
            Xaxis = new XAxis
            {
                Labels = new XAxisLabels { Style = new AxisLabelStyle { Colors = new List<string> { AxisLabelColor } } }
            },
            Yaxis = [new YAxis
            {
                Labels = new YAxisLabels
                {
                    Style = new AxisLabelStyle { Colors = new List<string> { AxisLabelColor } },
                    Formatter = "function(val) { return '$' + val.toLocaleString(); }"
                }
            }],
            DataLabels = new DataLabels { Enabled = false },
            Legend = new Legend { Show = true, Position = LegendPosition.Top, Labels = new LegendLabels { Colors = new ApexCharts.Color(AxisLabelColor) } },
            Grid = new Grid { BorderColor = GridColor, StrokeDashArray = 4 },
            Tooltip = new Tooltip
            {
                Theme = TooltipTheme,
                Y = new TooltipY { Formatter = "function(val) { return '$' + val.toLocaleString(); }" }
            },
            Colors = IsDarkMode ? ["#818cf8", "#fbbf24"] : ["#6366f1", "#f59e0b"]
        };
    }

    protected override async Task OnInitializedAsync()
    {
        BuildChartOptions();
        await LoadDataAsync();
    }

    protected override void OnParametersSet()
    {
        BuildChartOptions();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;

        var projectionResult = await ProjectionHandler.HandleAsync(new GetProjectionQuery(12));
        if (projectionResult.IsSuccess)
        {
            _projection = projectionResult.Value;
            PrepareCharts();
        }

        var kpisResult = await DashboardService.GetKpisAsync();
        if (kpisResult.IsSuccess)
        {
            _kpis = kpisResult.Value;
        }

        _isLoading = false;
    }

    private void PrepareCharts()
    {
        if (_projection is null) return;

        // Projection series
        _projectedSeries = _projection.MonthlyProjections
            .Select(p => new ProjectionChartPoint { Month = p.Month.ToString("MMM yy"), Amount = p.ProjectedUsd })
            .ToList();

        _upperBoundSeries = _projection.MonthlyProjections
            .Select(p => new ProjectionChartPoint { Month = p.Month.ToString("MMM yy"), Amount = p.UpperBoundUsd })
            .ToList();

        _lowerBoundSeries = _projection.MonthlyProjections
            .Select(p => new ProjectionChartPoint { Month = p.Month.ToString("MMM yy"), Amount = p.LowerBoundUsd })
            .ToList();

        // Composition donut
        _compositionDonutData =
        [
            new CompositionPoint { Label = "Fixed Income", Value = _projection.FixedComponentUsd },
            new CompositionPoint { Label = "Variable Income", Value = _projection.VariableComponentUsd }
        ];
    }

    private void OnGoalAmountChanged(decimal value)
    {
        _goalAmount = value;
        UpdateGoalProgressData();
        StateHasChanged();
    }

    private void UpdateGoalProgressData()
    {
        if (_projection is null || _goalAmount <= 0) return;

        decimal cumulative = 0;
        _goalProgressData = _projection.MonthlyProjections
            .Select(p =>
            {
                cumulative += p.ProjectedUsd;
                return new GoalProgressPoint
                {
                    Month = p.Month.ToString("MMM yy"),
                    Cumulative = cumulative
                };
            })
            .ToList();
    }

    private GoalScenarios CalculateGoalScenarios(decimal goalAmount)
    {
        if (_projection is null || _projection.MonthlyProjections.Count == 0)
        {
            return new GoalScenarios(
                new GoalScenarioResult(0, DateTime.UtcNow, 0),
                new GoalScenarioResult(0, DateTime.UtcNow, 0),
                new GoalScenarioResult(0, DateTime.UtcNow, 0));
        }

        // Calculate average monthly rates from projections
        var avgProjected = _projection.MonthlyProjections.Average(p => p.ProjectedUsd);
        var avgUpper = _projection.MonthlyProjections.Average(p => p.UpperBoundUsd);
        var avgLower = _projection.MonthlyProjections.Average(p => p.LowerBoundUsd);

        // Avoid division by zero
        avgProjected = avgProjected > 0 ? avgProjected : 1;
        avgUpper = avgUpper > 0 ? avgUpper : 1;
        avgLower = avgLower > 0 ? avgLower : 1;

        var monthsOptimistic = (int)Math.Ceiling(goalAmount / avgUpper);
        var monthsRealistic = (int)Math.Ceiling(goalAmount / avgProjected);
        var monthsPessimistic = (int)Math.Ceiling(goalAmount / avgLower);

        return new GoalScenarios(
            new GoalScenarioResult(monthsOptimistic, DateTime.UtcNow.AddMonths(monthsOptimistic), avgUpper),
            new GoalScenarioResult(monthsRealistic, DateTime.UtcNow.AddMonths(monthsRealistic), avgProjected),
            new GoalScenarioResult(monthsPessimistic, DateTime.UtcNow.AddMonths(monthsPessimistic), avgLower));
    }

    private int CalculateGoalProbability(GoalScenarios scenarios)
    {
        if (_projection is null) return 50;

        // Base probability on confidence score and scenario spread
        var baseProb = (int)(_projection.ConfidenceScore * 100);

        // Adjust based on how tight the scenarios are
        var spread = scenarios.Pessimistic.Months - scenarios.Optimistic.Months;
        var spreadFactor = spread switch
        {
            <= 2 => 15,   // Very tight spread = higher confidence
            <= 4 => 10,
            <= 6 => 5,
            <= 10 => 0,
            _ => -10      // Wide spread = lower confidence
        };

        return Math.Clamp(baseProb + spreadFactor, 10, 95);
    }

    private List<MilestoneItem> GetMilestones()
    {
        if (_projection is null) return [];

        var milestones = new List<MilestoneItem>();
        decimal cumulative = 0;
        decimal lowerCumulative = 0;
        decimal upperCumulative = 0;

        var intervals = new[] { 3, 6, 12 };
        var labels = new[] { "3 Months", "6 Months", "12 Months" };

        for (var i = 0; i < intervals.Length && i < _projection.MonthlyProjections.Count; i++)
        {
            var index = intervals[i] - 1;
            if (index >= _projection.MonthlyProjections.Count) break;

            for (var j = (i == 0 ? 0 : intervals[i - 1]); j <= index; j++)
            {
                cumulative += _projection.MonthlyProjections[j].ProjectedUsd;
                lowerCumulative += _projection.MonthlyProjections[j].LowerBoundUsd;
                upperCumulative += _projection.MonthlyProjections[j].UpperBoundUsd;
            }

            milestones.Add(new MilestoneItem(
                labels[i],
                _projection.MonthlyProjections[index].Month,
                cumulative,
                lowerCumulative,
                upperCumulative));
        }

        return milestones;
    }

    private record MilestoneItem(string Label, DateOnly Date, decimal Cumulative, decimal LowerBound, decimal UpperBound);

    private static string FormatCurrency(decimal amount) =>
        amount.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("en-US"));

    private static Color GetConfidenceColor(decimal score) => score switch
    {
        >= 0.7m => Color.Success,
        >= 0.4m => Color.Warning,
        _ => Color.Error
    };

    private static string GetConfidenceLabel(decimal score) => score switch
    {
        >= 0.7m => "High",
        >= 0.4m => "Medium",
        _ => "Low"
    };

    private static Severity GetConfidenceSeverity(decimal score) => score switch
    {
        >= 0.7m => Severity.Success,
        >= 0.4m => Severity.Warning,
        _ => Severity.Error
    };

    private static string GetConfidenceDescription(decimal score) => score switch
    {
        >= 0.7m => "Your income is highly predictable. Projections are based on stable, consistent patterns.",
        >= 0.4m => "Your income is reasonably predictable with some variability. Consider building an emergency fund.",
        _ => "High variability in your income. Projections are uncertain. Focus on increasing fixed income sources."
    };
}
