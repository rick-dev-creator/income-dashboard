@page "/streams"
@using Income.Application.Services.Streams
@using Income.Application.Services.Providers
@using Analytics.Application.Services
@inject IStreamService StreamService
@inject IProviderService ProviderService
@inject IDashboardService DashboardService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Income Streams - FlowMetrics</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <div>
        <MudText Typo="Typo.h4">Income Streams</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">Manage your income sources</MudText>
    </div>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
               OnClick="OpenCreateDialog">
        Add Stream
    </MudButton>
</MudStack>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else if (_streams.Count == 0)
{
    <MudPaper Class="pa-8 text-center" Elevation="2">
        <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="Size.Large" Color="Color.Secondary" />
        <MudText Typo="Typo.h6" Class="mt-4">No Income Streams Yet</MudText>
        <MudText Color="Color.Secondary" Class="mb-4">Start tracking your income by adding your first stream</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreateDialog">
            Add Your First Stream
        </MudButton>
    </MudPaper>
}
else
{
    <!-- Summary Stats -->
    <MudGrid Class="mb-4">
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Total Streams</MudText>
                <MudText Typo="Typo.h5">@_streams.Count</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Growing</MudText>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Success" Size="Size.Small" />
                    <MudText Typo="Typo.h5" Color="Color.Success">@_streamHealth?.GrowingCount</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Stable</MudText>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.TrendingFlat" Color="Color.Default" Size="Size.Small" />
                    <MudText Typo="Typo.h5">@_streamHealth?.StableCount</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Declining</MudText>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Color="Color.Error" Size="Size.Small" />
                    <MudText Typo="Typo.h5" Color="Color.Error">@_streamHealth?.DecliningCount</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid>
        @foreach (var stream in _streams)
        {
            var health = GetStreamHealth(stream.Id);
            <MudItem xs="12" md="6" lg="4">
                <MudCard Elevation="2" Style="height: 100%;">
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudAvatar Color="@GetCategoryColor(stream.Category)" Size="Size.Medium">
                                @stream.Category[0]
                            </MudAvatar>
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.h6">@stream.Name</MudText>
                                @if (health is not null)
                                {
                                    <MudIcon Icon="@GetDirectionIcon(health.Direction)"
                                             Color="@GetDirectionColor(health.Direction)"
                                             Size="Size.Small" />
                                }
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @GetProviderName(stream.ProviderId)
                            </MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                                <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditDialog(stream))">
                                    Edit
                                </MudMenuItem>
                                <MudMenuItem Icon="@Icons.Material.Filled.AddChart" OnClick="@(() => OpenSnapshotDialog(stream))">
                                    Add Snapshot
                                </MudMenuItem>
                                <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteStream(stream))"
                                             IconColor="Color.Error">
                                    Delete
                                </MudMenuItem>
                            </MudMenu>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <!-- Trend Indicator -->
                            @if (health is not null && health.ChangePercentage != 0)
                            {
                                <MudPaper Class="pa-2" Elevation="0" Style="@GetTrendBackground(health.Direction)">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.body2" Style="color: white;">
                                            @health.Direction this month
                                        </MudText>
                                        <MudText Typo="Typo.body1" Style="color: white; font-weight: 600;">
                                            @FormatSignedPercentage(health.ChangePercentage)
                                        </MudText>
                                    </MudStack>
                                </MudPaper>
                            }

                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Category</MudText>
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                                         Color="@GetCategoryColor(stream.Category)">@stream.Category</MudChip>
                            </MudStack>
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Type</MudText>
                                <MudText>@(stream.IsFixed ? $"Fixed ({stream.FixedPeriod})" : "Variable")</MudText>
                            </MudStack>
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Currency</MudText>
                                <MudText>@stream.OriginalCurrency</MudText>
                            </MudStack>

                            @if (stream.LastSnapshot is not null)
                            {
                                <MudDivider Class="my-2" />
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.End">
                                    <div>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Last Recorded</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @stream.LastSnapshot.Date.ToString("MMM dd, yyyy")
                                        </MudText>
                                    </div>
                                    <div style="text-align: right;">
                                        <MudText Typo="Typo.h5" Color="Color.Success">
                                            @FormatCurrency(stream.LastSnapshot.UsdAmount)
                                        </MudText>
                                        @if (health?.CurrentPeriodUsd > 0)
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @FormatCurrency(health.CurrentPeriodUsd) this month
                                            </MudText>
                                        }
                                    </div>
                                </MudStack>
                            }
                            else
                            {
                                <MudDivider Class="my-2" />
                                <MudAlert Severity="Severity.Info" Dense="true" NoIcon="true">
                                    <MudText Typo="Typo.caption">No snapshots yet</MudText>
                                </MudAlert>
                            }
                        </MudStack>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" FullWidth="true"
                                   OnClick="@(() => OpenSnapshotDialog(stream))"
                                   StartIcon="@Icons.Material.Filled.AddChart">
                            Record Income
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
}

@code {
    private bool _isLoading = true;
    private List<StreamListItem> _streams = [];
    private Dictionary<string, ProviderListItem> _providers = [];
    private StreamHealthSummary? _streamHealth;
    private Dictionary<string, StreamHealthItem> _streamHealthMap = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;

        var streamsResult = await StreamService.GetAllAsync();
        var providersResult = await ProviderService.GetAllAsync();
        var healthResult = await DashboardService.GetStreamHealthAsync("MoM");

        if (streamsResult.IsSuccess)
            _streams = streamsResult.Value.ToList();

        if (providersResult.IsSuccess)
            _providers = providersResult.Value.ToDictionary(p => p.Id, p => p);

        if (healthResult.IsSuccess)
        {
            _streamHealth = healthResult.Value;
            _streamHealthMap = _streamHealth.Streams.ToDictionary(s => s.StreamId, s => s);
        }

        _isLoading = false;
    }

    private StreamHealthItem? GetStreamHealth(string streamId) =>
        _streamHealthMap.TryGetValue(streamId, out var health) ? health : null;

    private string GetProviderName(string providerId) =>
        _providers.TryGetValue(providerId, out var provider) ? provider.Name : providerId;

    private static Color GetCategoryColor(string category) => category.ToLower() switch
    {
        "salary" => Color.Primary,
        "trading" => Color.Warning,
        "subscription" => Color.Info,
        "referral" => Color.Success,
        _ => Color.Default
    };

    private static string GetDirectionIcon(string? direction) => direction switch
    {
        "Upward" => Icons.Material.Filled.TrendingUp,
        "Downward" => Icons.Material.Filled.TrendingDown,
        _ => Icons.Material.Filled.TrendingFlat
    };

    private static Color GetDirectionColor(string? direction) => direction switch
    {
        "Upward" => Color.Success,
        "Downward" => Color.Error,
        _ => Color.Default
    };

    private static string GetTrendBackground(string? direction) => direction switch
    {
        "Upward" => "background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); border-radius: 4px;",
        "Downward" => "background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%); border-radius: 4px;",
        _ => "background: linear-gradient(135deg, #37474f 0%, #455a64 100%); border-radius: 4px;"
    };

    private static string FormatCurrency(decimal amount) =>
        amount.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("en-US"));

    private static string FormatSignedPercentage(decimal percentage) =>
        $"{(percentage >= 0 ? "+" : "")}{percentage:F1}%";

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters<StreamDialog>
        {
            { x => x.Providers, _providers.Values.ToList() }
        };

        var dialog = await DialogService.ShowAsync<StreamDialog>("Create Stream", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        var result = await dialog.Result;
        if (result is { Canceled: false, Data: CreateStreamRequest request })
        {
            var createResult = await StreamService.CreateAsync(request);
            if (createResult.IsSuccess)
            {
                Snackbar.Add("Stream created successfully!", Severity.Success);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add($"Error: {createResult.Errors.FirstOrDefault()?.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditDialog(StreamListItem stream)
    {
        var parameters = new DialogParameters<StreamDialog>
        {
            { x => x.Providers, _providers.Values.ToList() },
            { x => x.ExistingStream, stream }
        };

        var dialog = await DialogService.ShowAsync<StreamDialog>("Edit Stream", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        var result = await dialog.Result;
        if (result is { Canceled: false, Data: UpdateStreamRequest request })
        {
            var updateResult = await StreamService.UpdateAsync(request);
            if (updateResult.IsSuccess)
            {
                Snackbar.Add("Stream updated successfully!", Severity.Success);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add($"Error: {updateResult.Errors.FirstOrDefault()?.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenSnapshotDialog(StreamListItem stream)
    {
        var parameters = new DialogParameters<SnapshotDialog>
        {
            { x => x.Stream, stream }
        };

        var dialog = await DialogService.ShowAsync<SnapshotDialog>("Record Snapshot", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        var result = await dialog.Result;
        if (result is { Canceled: false, Data: RecordSnapshotRequest request })
        {
            var snapshotResult = await StreamService.RecordSnapshotAsync(request);
            if (snapshotResult.IsSuccess)
            {
                Snackbar.Add("Snapshot recorded successfully!", Severity.Success);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add($"Error: {snapshotResult.Errors.FirstOrDefault()?.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteStream(StreamListItem stream)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete Stream",
            $"Are you sure you want to delete '{stream.Name}'? This will also delete all associated snapshots.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            var deleteResult = await StreamService.DeleteAsync(stream.Id);
            if (deleteResult.IsSuccess)
            {
                Snackbar.Add("Stream deleted successfully!", Severity.Success);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add($"Error: {deleteResult.Errors.FirstOrDefault()?.Message}", Severity.Error);
            }
        }
    }
}
