@using Income.Application.Services.Streams
@using Income.Application.Services.Providers
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Stream" Class="mr-2" />
            @(ExistingStream is null ? "Create Stream" : "Edit Stream")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_formValid">
            <MudStack Spacing="3">
                <MudSelect T="string" Label="Provider" @bind-Value="_providerId" Required="true"
                           RequiredError="Provider is required" Variant="Variant.Outlined"
                           Disabled="@(ExistingStream is not null)">
                    @foreach (var provider in Providers)
                    {
                        <MudSelectItem Value="@provider.Id">@provider.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudTextField @bind-Value="_name" Label="Stream Name" Required="true"
                              RequiredError="Name is required" Variant="Variant.Outlined" />

                <MudSelect T="string" Label="Category" @bind-Value="_category" Required="true"
                           RequiredError="Category is required" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("Salary")">Salary</MudSelectItem>
                    <MudSelectItem Value="@("Trading")">Trading</MudSelectItem>
                    <MudSelectItem Value="@("Subscription")">Subscription</MudSelectItem>
                    <MudSelectItem Value="@("Referral")">Referral</MudSelectItem>
                    <MudSelectItem Value="@("Freelance")">Freelance</MudSelectItem>
                    <MudSelectItem Value="@("Investment")">Investment</MudSelectItem>
                    <MudSelectItem Value="@("Other")">Other</MudSelectItem>
                </MudSelect>

                <MudSelect T="string" Label="Currency" @bind-Value="_currency" Required="true"
                           RequiredError="Currency is required" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("USD")">USD - US Dollar</MudSelectItem>
                    <MudSelectItem Value="@("EUR")">EUR - Euro</MudSelectItem>
                    <MudSelectItem Value="@("GBP")">GBP - British Pound</MudSelectItem>
                    <MudSelectItem Value="@("USDT")">USDT - Tether</MudSelectItem>
                    <MudSelectItem Value="@("BTC")">BTC - Bitcoin</MudSelectItem>
                </MudSelect>

                @if (ExistingStream is null)
                {
                    <MudSwitch @bind-Value="_isFixed" Label="Fixed Income" Color="Color.Primary" />

                    @if (_isFixed)
                    {
                        <MudSelect T="string" Label="Period" @bind-Value="_fixedPeriod" Required="true"
                                   RequiredError="Period is required for fixed income" Variant="Variant.Outlined">
                            <MudSelectItem Value="@("Daily")">Daily</MudSelectItem>
                            <MudSelectItem Value="@("Weekly")">Weekly</MudSelectItem>
                            <MudSelectItem Value="@("Biweekly")">Biweekly</MudSelectItem>
                            <MudSelectItem Value="@("Monthly")">Monthly</MudSelectItem>
                            <MudSelectItem Value="@("Quarterly")">Quarterly</MudSelectItem>
                            <MudSelectItem Value="@("Annually")">Annually</MudSelectItem>
                        </MudSelect>
                    }
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Dense="true">
                        Income type (@(ExistingStream.IsFixed ? "Fixed" : "Variable")@(ExistingStream.FixedPeriod is not null ? $" - {ExistingStream.FixedPeriod}" : "")) cannot be changed after creation.
                    </MudAlert>
                }
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit"
                   Disabled="@(!_formValid)">
            @(ExistingStream is null ? "Create" : "Update")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public List<ProviderListItem> Providers { get; set; } = [];

    [Parameter]
    public StreamListItem? ExistingStream { get; set; }

    private MudForm _form = null!;
    private bool _formValid;

    private string _providerId = "";
    private string _name = "";
    private string _category = "Salary";
    private string _currency = "USD";
    private bool _isFixed = true;
    private string _fixedPeriod = "Monthly";

    protected override void OnInitialized()
    {
        if (ExistingStream is not null)
        {
            _providerId = ExistingStream.ProviderId;
            _name = ExistingStream.Name;
            _category = ExistingStream.Category;
            _currency = ExistingStream.OriginalCurrency;
            _isFixed = ExistingStream.IsFixed;
            _fixedPeriod = ExistingStream.FixedPeriod ?? "Monthly";
        }
        else if (Providers.Count > 0)
        {
            _providerId = Providers[0].Id;
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private void Submit()
    {
        if (ExistingStream is null)
        {
            var request = new CreateStreamRequest(
                ProviderId: _providerId,
                Name: _name,
                Category: _category,
                OriginalCurrency: _currency,
                IsFixed: _isFixed,
                FixedPeriod: _isFixed ? _fixedPeriod : null);
            MudDialog.Close(DialogResult.Ok(request));
        }
        else
        {
            var request = new UpdateStreamRequest(
                StreamId: ExistingStream.Id,
                Name: _name,
                Category: _category);
            MudDialog.Close(DialogResult.Ok(request));
        }
    }
}
