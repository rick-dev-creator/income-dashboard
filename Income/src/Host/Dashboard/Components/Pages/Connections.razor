@page "/connections"
@using Income.Application.Connectors
@using Income.Application.Services.Providers
@using Income.Application.Services.Streams
@inject IProviderService ProviderService
@inject IStreamService StreamService
@inject IConnectorRegistry ConnectorRegistry
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Connections - FlowMetrics</PageTitle>

<div class="page-header page-header-flex">
    <div>
        <h1 class="page-title">Connections</h1>
        <p class="page-subtitle">Manage your income sources</p>
    </div>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="btn-modern btn-mobile-full"
               StartIcon="@Icons.Material.Rounded.Add" OnClick="OpenAddIncomeDialog">
        Add Income Source
    </MudButton>
</div>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else if (_providers.Count == 0)
{
    <MudPaper Class="pa-8 text-center" Elevation="2">
        <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Size="Size.Large" Color="Color.Secondary" />
        <MudText Typo="Typo.h6" Class="mt-4">No Income Sources</MudText>
        <MudText Color="Color.Secondary" Class="mb-4">Add recurring income like salary or rent to start tracking</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddIncomeDialog">
            Add Your First Income Source
        </MudButton>
    </MudPaper>
}
else
{
    <MudGrid>
        @foreach (var provider in _providers)
        {
            <MudItem xs="12" md="6" lg="4">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudAvatar Color="@GetConnectorColor(provider.ConnectorKind)">
                                <MudIcon Icon="@GetConnectorIcon(provider.ConnectorKind)" />
                            </MudAvatar>
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@provider.Name</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                                     Color="@GetConnectorColor(provider.ConnectorKind)">
                                @GetConnectorLabel(provider.ConnectorKind)
                            </MudChip>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Default Currency</MudText>
                                <MudText>@provider.DefaultCurrency</MudText>
                            </MudStack>
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Income Streams</MudText>
                                <MudText>@GetStreamCount(provider.Id)</MudText>
                            </MudStack>
                            @if (provider.ConnectorKind == "Recurring")
                            {
                                <MudDivider Class="my-2" />
                                <MudStack Row="true" AlignItems="AlignItems.Center">
                                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Color="Color.Success" />
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Auto-generates snapshots on schedule
                                    </MudText>
                                </MudStack>
                            }
                        </MudStack>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Text" Color="Color.Primary"
                                   Href="@($"/streams?provider={provider.Id}")">
                            View Streams
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    <!-- Connector Types Legend -->
    <MudPaper Class="pa-4 mt-4" Elevation="1">
        <MudText Typo="Typo.subtitle2" Class="mb-3">Income Source Types</MudText>
        <div class="provider-types-grid">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudAvatar Size="Size.Small" Color="Color.Success">
                    <MudIcon Icon="@Icons.Material.Filled.EventRepeat" Size="Size.Small" />
                </MudAvatar>
                <MudText Typo="Typo.body2">Recurring - Salary, Rent (auto-tracked)</MudText>
            </MudStack>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudAvatar Size="Size.Small" Color="Color.Info">
                    <MudIcon Icon="@Icons.Material.Filled.Sync" Size="Size.Small" />
                </MudAvatar>
                <MudText Typo="Typo.body2">API Integration - Exchange balances (syncs daily)</MudText>
            </MudStack>
        </div>
    </MudPaper>
}

<style>
    .provider-types-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
    }

    @@media (max-width: 599px) {
        .provider-types-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
    }
</style>

@code {
    private bool _isLoading = true;
    private List<ProviderListItem> _providers = [];
    private Dictionary<string, int> _streamCounts = [];
    private HashSet<string> _availableConnectorIds = [];

    protected override async Task OnInitializedAsync()
    {
        // Get available connector IDs
        _availableConnectorIds = ConnectorRegistry.GetAll()
            .Select(c => c.ProviderId)
            .ToHashSet(StringComparer.OrdinalIgnoreCase);

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;

        var providersResult = await ProviderService.GetAllAsync();

        if (providersResult.IsSuccess)
        {
            // Only show providers that have matching connectors
            _providers = providersResult.Value
                .Where(p => _availableConnectorIds.Contains(p.Id))
                .ToList();

            // Load stream counts for each provider
            foreach (var provider in _providers)
            {
                var streamsResult = await StreamService.GetByProviderAsync(provider.Id);
                if (streamsResult.IsSuccess)
                {
                    _streamCounts[provider.Id] = streamsResult.Value.Count;
                }
            }
        }

        _isLoading = false;
    }

    private int GetStreamCount(string providerId) =>
        _streamCounts.TryGetValue(providerId, out var count) ? count : 0;

    private static Color GetConnectorColor(string connectorKind) => connectorKind.ToLower() switch
    {
        "recurring" => Color.Success,
        "syncable" => Color.Info,
        _ => Color.Default
    };

    private static string GetConnectorIcon(string connectorKind) => connectorKind.ToLower() switch
    {
        "recurring" => Icons.Material.Filled.EventRepeat,
        "syncable" => Icons.Material.Filled.Sync,
        _ => Icons.Material.Filled.QuestionMark
    };

    private static string GetConnectorLabel(string connectorKind) => connectorKind.ToLower() switch
    {
        "recurring" => "Recurring Income",
        "syncable" => "API Sync",
        _ => connectorKind
    };

    private async Task OpenAddIncomeDialog()
    {
        var dialog = await DialogService.ShowAsync<AddIncomeSourceDialog>("Add Income Source",
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        var result = await dialog.Result;
        if (result is { Canceled: false })
        {
            await LoadDataAsync();
        }
    }
}
