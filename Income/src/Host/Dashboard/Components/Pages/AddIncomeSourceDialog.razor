@using Income.Application.Connectors
@using Income.Application.Services.Streams
@using System.Text.Json
@inject IConnectorRegistry ConnectorRegistry
@inject IStreamService StreamService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
            @GetDialogTitle()
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_step == Step.SelectType)
        {
            <MudText Class="mb-4">What type of income do you want to track?</MudText>
            <MudStack Spacing="3">
                <MudCard Class="cursor-pointer hover-card" @onclick="SelectRecurring" Elevation="2">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <MudAvatar Color="Color.Success" Size="Size.Large">
                                <MudIcon Icon="@Icons.Material.Filled.EventRepeat" />
                            </MudAvatar>
                            <div>
                                <MudText Typo="Typo.h6">Recurring Income</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Salary, rent, subscriptions - fixed amounts on a schedule
                                </MudText>
                            </div>
                        </MudStack>
                    </MudCardContent>
                </MudCard>

                <MudCard Class="cursor-pointer hover-card" @onclick="SelectApiIntegration" Elevation="2">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <MudAvatar Color="Color.Info" Size="Size.Large">
                                <MudIcon Icon="@Icons.Material.Filled.Sync" />
                            </MudAvatar>
                            <div>
                                <MudText Typo="Typo.h6">API Integration</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Exchanges, platforms - sync automatically via API
                                </MudText>
                            </div>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudStack>
        }
        else if (_step == Step.SelectConnector)
        {
            <MudText Class="mb-4">Select an integration:</MudText>
            <MudStack Spacing="2">
                @foreach (var connector in _syncableConnectors)
                {
                    <MudCard Class="cursor-pointer hover-card" @onclick="() => SelectConnector(connector)" Elevation="2">
                        <MudCardContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                <MudAvatar Color="Color.Info">
                                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" />
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.subtitle1">@connector.DisplayName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @connector.ProviderType - @connector.DefaultCurrency
                                    </MudText>
                                </div>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                }
            </MudStack>
            @if (!_syncableConnectors.Any())
            {
                <MudAlert Severity="Severity.Info">No API integrations available yet.</MudAlert>
            }
        }
        else if (_step == Step.ConfigureConnector)
        {
            <MudForm @ref="_form" @bind-IsValid="_formValid">
                <MudStack Spacing="3">
                    <MudTextField @bind-Value="_name" Label="Stream Name" Required="true"
                                  RequiredError="Name is required" Variant="Variant.Outlined"
                                  Placeholder="e.g., My Blofin Account" />

                    <MudSelect T="string" Label="Category" @bind-Value="_category" Required="true"
                               RequiredError="Category is required" Variant="Variant.Outlined">
                        <MudSelectItem Value="@("Trading")">Trading</MudSelectItem>
                        <MudSelectItem Value="@("Investment")">Investment</MudSelectItem>
                        <MudSelectItem Value="@("Staking")">Staking</MudSelectItem>
                        <MudSelectItem Value="@("Other")">Other</MudSelectItem>
                    </MudSelect>

                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">API Credentials</MudText>

                    @* Dynamic credentials form based on ConfigSchema *@
                    <MudTextField @bind-Value="_apiKey" Label="API Key" Required="true"
                                  RequiredError="API Key is required" Variant="Variant.Outlined"
                                  InputType="@(_showApiKey ? InputType.Text : InputType.Password)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_showApiKey ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                  OnAdornmentClick="() => _showApiKey = !_showApiKey" />

                    <MudTextField @bind-Value="_secretKey" Label="Secret Key" Required="true"
                                  RequiredError="Secret Key is required" Variant="Variant.Outlined"
                                  InputType="@(_showSecretKey ? InputType.Text : InputType.Password)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_showSecretKey ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                  OnAdornmentClick="() => _showSecretKey = !_showSecretKey" />

                    <MudTextField @bind-Value="_passphrase" Label="Passphrase" Required="true"
                                  RequiredError="Passphrase is required" Variant="Variant.Outlined"
                                  InputType="@(_showPassphrase ? InputType.Text : InputType.Password)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_showPassphrase ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                  OnAdornmentClick="() => _showPassphrase = !_showPassphrase" />

                    <MudCheckBox @bind-Value="_isDemo" Label="Demo Mode (use demo trading environment)" Color="Color.Primary" />

                    @if (!string.IsNullOrEmpty(_validationError))
                    {
                        <MudAlert Severity="Severity.Error" Dense="true">@_validationError</MudAlert>
                    }

                    <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                        <MudStack>
                            <MudText Typo="Typo.body2">Your credentials will be encrypted and stored securely.</MudText>
                            <MudText Typo="Typo.body2">Balance will sync automatically every 24 hours.</MudText>
                        </MudStack>
                    </MudAlert>
                </MudStack>
            </MudForm>
        }
        else if (_step == Step.ConfigureRecurring)
        {
            <MudForm @ref="_form" @bind-IsValid="_formValid">
                <MudStack Spacing="3">
                    <MudTextField @bind-Value="_name" Label="Income Name" Required="true"
                                  RequiredError="Name is required" Variant="Variant.Outlined"
                                  Placeholder="e.g., Monthly Salary, Apartment Rent" />

                    <MudSelect T="string" Label="Category" @bind-Value="_category" Required="true"
                               RequiredError="Category is required" Variant="Variant.Outlined">
                        <MudSelectItem Value="@("Salary")">Salary</MudSelectItem>
                        <MudSelectItem Value="@("Rental")">Rental Income</MudSelectItem>
                        <MudSelectItem Value="@("Dividend")">Dividend</MudSelectItem>
                        <MudSelectItem Value="@("Subscription")">Subscription</MudSelectItem>
                        <MudSelectItem Value="@("Other")">Other</MudSelectItem>
                    </MudSelect>

                    <MudNumericField T="decimal" @bind-Value="_amount" Label="Amount" Required="true"
                                     RequiredError="Amount is required" Variant="Variant.Outlined"
                                     Min="0.01m" Format="N2" Adornment="Adornment.Start"
                                     AdornmentText="$" />

                    <MudSelect T="string" Label="Currency" @bind-Value="_currency" Required="true"
                               RequiredError="Currency is required" Variant="Variant.Outlined">
                        <MudSelectItem Value="@("USD")">USD - US Dollar</MudSelectItem>
                        <MudSelectItem Value="@("EUR")">EUR - Euro</MudSelectItem>
                        <MudSelectItem Value="@("GBP")">GBP - British Pound</MudSelectItem>
                        <MudSelectItem Value="@("MXN")">MXN - Mexican Peso</MudSelectItem>
                    </MudSelect>

                    <MudSelect T="int" Label="Frequency" @bind-Value="_frequency" Required="true"
                               RequiredError="Frequency is required" Variant="Variant.Outlined">
                        <MudSelectItem Value="0">Daily (Testing)</MudSelectItem>
                        <MudSelectItem Value="1">Weekly</MudSelectItem>
                        <MudSelectItem Value="2">Bi-Weekly</MudSelectItem>
                        <MudSelectItem Value="3">Monthly</MudSelectItem>
                        <MudSelectItem Value="4">Quarterly</MudSelectItem>
                        <MudSelectItem Value="5">Yearly</MudSelectItem>
                    </MudSelect>

                    <MudDatePicker @bind-Date="_startDate" Label="First Payment Date" Required="true"
                                   RequiredError="Start date is required" Variant="Variant.Outlined"
                                   Placeholder="When did/will payments start?" />

                    <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                        Snapshots will be automatically generated on each payment date.
                    </MudAlert>
                </MudStack>
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        @if (_step == Step.SelectType)
        {
            <MudButton OnClick="Cancel">Cancel</MudButton>
        }
        else if (_step == Step.SelectConnector)
        {
            <MudButton OnClick="GoBackToType">Back</MudButton>
            <MudButton OnClick="Cancel">Cancel</MudButton>
        }
        else if (_step == Step.ConfigureConnector)
        {
            <MudButton OnClick="GoBackToConnectorList">Back</MudButton>
            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="ValidateCredentials"
                       Disabled="@(!CanValidate() || _isValidating)">
                @if (_isValidating)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Test Connection
            </MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateSyncableStream"
                       Disabled="@(!_formValid || _isCreating || !_credentialsValidated)">
                @if (_isCreating)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Create
            </MudButton>
        }
        else
        {
            <MudButton OnClick="GoBackToType">Back</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateRecurringStream"
                       Disabled="@(!_formValid || _isCreating)">
                @if (_isCreating)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Create
            </MudButton>
        }
    </DialogActions>
</MudDialog>

<style>
    .hover-card:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
    .cursor-pointer {
        cursor: pointer;
    }
</style>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private enum Step { SelectType, SelectConnector, ConfigureConnector, ConfigureRecurring }
    private Step _step = Step.SelectType;

    private MudForm _form = null!;
    private bool _formValid;
    private bool _isCreating;
    private bool _isValidating;
    private bool _credentialsValidated;
    private string? _validationError;

    // Available syncable connectors
    private IReadOnlyList<ISyncableConnector> _syncableConnectors = [];
    private ISyncableConnector? _selectedConnector;

    // Form fields - Common
    private string _name = "";
    private string _category = "Trading";
    private string _currency = "USD";

    // Form fields - Recurring
    private decimal _amount = 0;
    private int _frequency = 3; // Monthly
    private DateTime? _startDate = DateTime.Today;

    // Form fields - API Credentials
    private string _apiKey = "";
    private string _secretKey = "";
    private string _passphrase = "";
    private bool _isDemo = false;
    private bool _showApiKey = false;
    private bool _showSecretKey = false;
    private bool _showPassphrase = false;

    protected override void OnInitialized()
    {
        _syncableConnectors = ConnectorRegistry.GetSyncable();
    }

    private string GetDialogTitle() => _step switch
    {
        Step.SelectType => "Add Income Source",
        Step.SelectConnector => "Select Integration",
        Step.ConfigureConnector => $"Configure {_selectedConnector?.DisplayName ?? "Integration"}",
        Step.ConfigureRecurring => "Configure Recurring Income",
        _ => "Add Income Source"
    };

    private void Cancel() => MudDialog.Cancel();

    private void GoBackToType()
    {
        _step = Step.SelectType;
        ResetForm();
    }

    private void GoBackToConnectorList()
    {
        _step = Step.SelectConnector;
        ResetCredentialFields();
    }

    private void SelectRecurring()
    {
        _category = "Salary";
        _step = Step.ConfigureRecurring;
    }

    private void SelectApiIntegration()
    {
        _step = Step.SelectConnector;
    }

    private void SelectConnector(ISyncableConnector connector)
    {
        _selectedConnector = connector;
        _name = $"My {connector.DisplayName}";
        _currency = connector.DefaultCurrency;
        _step = Step.ConfigureConnector;
    }

    private void ResetForm()
    {
        _name = "";
        _category = "Trading";
        _amount = 0;
        _selectedConnector = null;
        ResetCredentialFields();
    }

    private void ResetCredentialFields()
    {
        _apiKey = "";
        _secretKey = "";
        _passphrase = "";
        _isDemo = false;
        _credentialsValidated = false;
        _validationError = null;
    }

    private bool CanValidate() =>
        !string.IsNullOrWhiteSpace(_apiKey) &&
        !string.IsNullOrWhiteSpace(_secretKey) &&
        !string.IsNullOrWhiteSpace(_passphrase);

    private string BuildCredentialsJson() => JsonSerializer.Serialize(new
    {
        apiKey = _apiKey,
        secretKey = _secretKey,
        passphrase = _passphrase,
        isDemo = _isDemo
    });

    private async Task ValidateCredentials()
    {
        if (_selectedConnector is null) return;

        _isValidating = true;
        _validationError = null;
        _credentialsValidated = false;

        try
        {
            var credentials = BuildCredentialsJson();
            var result = await _selectedConnector.ValidateCredentialsAsync(credentials);

            if (result.IsSuccess)
            {
                _credentialsValidated = true;
                Snackbar.Add("Connection successful! Credentials are valid.", Severity.Success);
            }
            else
            {
                _validationError = string.Join(", ", result.Errors.Select(e => e.Message));
                Snackbar.Add("Connection failed. Please check your credentials.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _validationError = ex.Message;
            Snackbar.Add($"Connection error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isValidating = false;
        }
    }

    private async Task CreateSyncableStream()
    {
        if (!_formValid || _selectedConnector is null || !_credentialsValidated) return;

        _isCreating = true;

        try
        {
            var credentials = BuildCredentialsJson();

            var request = new CreateStreamRequest(
                ProviderId: _selectedConnector.ProviderId,
                Name: _name,
                Category: _category,
                OriginalCurrency: _selectedConnector.DefaultCurrency,
                IsFixed: false,
                FixedPeriod: null,
                Credentials: credentials,
                RecurringAmount: null,
                RecurringFrequency: null,
                RecurringStartDate: null);

            var result = await StreamService.CreateAsync(request);

            if (result.IsSuccess)
            {
                Snackbar.Add($"Stream '{_name}' created successfully! First sync will run shortly.", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add($"Error: {result.Errors.FirstOrDefault()?.Message}", Severity.Error);
            }
        }
        finally
        {
            _isCreating = false;
        }
    }

    private async Task CreateRecurringStream()
    {
        if (!_formValid || _startDate is null) return;

        _isCreating = true;

        try
        {
            var request = new CreateStreamRequest(
                ProviderId: BuiltInProviders.RecurringIncome,
                Name: _name,
                Category: _category,
                OriginalCurrency: _currency,
                IsFixed: true,
                FixedPeriod: GetFrequencyLabel(_frequency),
                Credentials: null,
                RecurringAmount: _amount,
                RecurringFrequency: _frequency,
                RecurringStartDate: DateOnly.FromDateTime(_startDate.Value));

            var result = await StreamService.CreateAsync(request);

            if (result.IsSuccess)
            {
                Snackbar.Add($"Income stream '{_name}' created successfully!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add($"Error: {result.Errors.FirstOrDefault()?.Message}", Severity.Error);
            }
        }
        finally
        {
            _isCreating = false;
        }
    }

    private static string GetFrequencyLabel(int frequency) => frequency switch
    {
        0 => "Daily",
        1 => "Weekly",
        2 => "BiWeekly",
        3 => "Monthly",
        4 => "Quarterly",
        5 => "Yearly",
        _ => "Monthly"
    };
}
